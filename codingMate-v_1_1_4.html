<!doctype html>
<!--
 VHDR ‚Äî CodingAgent Companion ‚Äî SINGLE FILE
 Version: v1.1.4  |  Codename: NO-TEMPLATES-ALL  |  Build: 2025-09-26  Europe/Warsaw
 Purpose: Local HTML5 app to assemble a robust one-shot ‚Äúsuper prompt‚Äù, parse AI repo fences, and apply changes ‚Äî no APIs.
 Changelog (latest first):
 - v1.1.4: Removed ALL JS template literals; DOM-built UI fragments (no risky innerHTML with dynamic strings); safer status updates; prompt builder via array join.
 - v1.1.3: Array-join builder; removed template-literal risks in builder; fixed applyAll.
 - v1.1.2: Backtick-safe attempt with injected ticks.
 - v1.1.1: tryBuild guard, auto-build on load, proper "\n" joins, clearer errors.
 - v1.1.0: One-column layout; advanced options; settings import/export; hardened parser; self-test.
 - v1.0.0: Initial two-column builder with ingest/diff/write.
-->
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>CodingAgent Companion v1.1.4 ‚Äî One-Column (No API)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#0b0e12;--card:#131a22;--ink:#e9eef6;--mute:#a9b4c0;--line:#1f2a35;--inset:#0e141a;
      --accent:#1e90ff;--ok:#83e377;--warn:#ffd166;--bad:#ff6b6b;--tag:#233040;
      --radius:12px;--gap:10px;--pad:12px;--mono:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;
      --maxw:880px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:#9ad;text-decoration:none}
    h1{font-size:18px;margin:0 0 6px}
    h3{margin:0 0 8px}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:12px}
    .stack{display:flex;flex-direction:column;gap:var(--gap)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:var(--pad);box-shadow:0 0 0 1px var(--inset) inset}
    label{display:block;margin:6px 0 4px;color:#c8d3df}
    input[type=text],input[type=number],textarea,select{
      width:100%;box-sizing:border-box;background:var(--inset);border:1px solid #253242;border-radius:10px;color:var(--ink);
      padding:9px 10px;font:14px/1.4 inherit;outline:none
    }
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row > *{flex:1 1 160px}
    .btn{background:var(--accent);border:0;border-radius:10px;padding:9px 12px;color:#fff;font-weight:600;cursor:pointer}
    .btn.secondary{background:#2b3948}
    .btn.ghost{background:transparent;border:1px solid #2b3948;color:#c8d3df}
    .btn.small{padding:6px 8px;font-weight:600}
    .small{font-size:12px;color:var(--mute)}
    .mono{font-family:var(--mono)}
    .pill{display:inline-block;border:1px solid #2b3948;border-radius:999px;padding:2px 8px;margin-right:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .files{max-height:180px;overflow:auto;border:1px dashed #2b3948;border-radius:10px;padding:8px;background:var(--inset)}
    .drop{border:2px dashed #425a74;border-radius:12px;padding:10px;text-align:center;color:var(--mute)}
    .code{white-space:pre-wrap;background:var(--inset);border:1px solid #253242;border-radius:10px;padding:10px;max-height:340px;overflow:auto}
    details summary{cursor:pointer}
    .diff{white-space:pre-wrap;background:var(--inset);border:1px solid #314154;border-radius:10px;padding:10px}
    .add{background:#0b2e16} .del{background:#3a1111}
    .filelist{max-height:260px;overflow:auto}
    .tag{background:var(--tag);border-radius:8px;padding:2px 6px;margin:0 4px 4px 0;display:inline-block}
    .bar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .tight > *+*{margin-top:6px}
    .status{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
<div class="wrap">
  <h1>‚öôÔ∏è CodingAgent Companion ‚Äî One-Column Builder (No API)</h1>
  <div class="status small" id="selftest">Self-test: <span class="pill">running‚Ä¶</span> <span id="errline"></span></div>

  <div class="stack">

    <div class="card">
      <h3>0) Settings & Presets</h3>
      <div class="row">
        <div>
          <label>Preset</label>
          <select id="preset">
            <option value="usrp">USRP v2.2 ‚Äî Double-Precision</option>
            <option value="hfsoneshot">HFS-OSCAP ‚Äî One-Shot</option>
            <option value="minimal">Minimal Clean</option>
          </select>
        </div>
        <div>
          <label>Persona / Style</label>
          <select id="persona">
            <option value="concise">Concise professional</option>
            <option value="research">Research-heavy (citations)</option>
            <option value="coach">Coach/mentor tone</option>
          </select>
        </div>
        <div>
          <label>Language</label>
          <select id="outlang">
            <option>en</option><option>de</option><option>nl</option><option>pl</option><option>af</option>
          </select>
        </div>
      </div>
      <div class="bar" style="margin-top:8px">
        <button id="saveLocal" class="btn small">üíæ Save (local)</button>
        <button id="loadLocal" class="btn secondary small">‚Ü© Load (local)</button>
        <input id="importFile" type="file" accept="application/json" style="display:none">
        <button id="importJSON" class="btn ghost small">üì• Import JSON</button>
        <button id="exportJSON" class="btn ghost small">üì§ Export JSON</button>
        <button id="resetDefaults" class="btn ghost small">‚ôª Reset</button>
      </div>
      <div class="small">Settings are auto-saved to localStorage; you can also import/export a JSON profile.</div>
    </div>

    <div class="card">
      <h3>1) Project & Task</h3>
      <div class="row">
        <div><label>Project Name</label><input id="proj" type="text" placeholder="DoAndroidsTrain"></div>
        <div><label>License</label>
          <select id="license"><option>MIT</option><option>Apache-2.0</option><option>Proprietary</option></select>
        </div>
      </div>
      <div class="row">
        <div><label>Task Title</label><input id="title" type="text" placeholder="HTML5 Affirmations App vNext"></div>
        <div><label>Non-functional Target</label><input id="nfr" type="text" placeholder="LCP < 2.5s, WCAG AA"></div>
      </div>
      <label>Objective (2‚Äì4 sentences)</label>
      <textarea id="objective" placeholder="What to build/fix and why..."></textarea>
      <div class="row">
        <div><label>Requirement 1</label><input id="req1" type="text" placeholder="Play/pause, per-voice FX"></div>
        <div><label>Requirement 2</label><input id="req2" type="text" placeholder="Echo/reverb routing"></div>
      </div>
      <div class="row">
        <div><label>ESLint warnings ‚â§</label><input id="warncap" type="number" min="0" value="0"></div>
        <div><label>Dev Port (Frontend)</label><input id="devport" type="number" value="5173"></div>
        <div><label>API Port (Backend)</label><input id="apiport" type="number" value="3000"></div>
      </div>
    </div>

    <div class="card tight">
      <h3>2) Advanced Prompt Options</h3>
      <div class="row">
        <div>
          <label>Include Sections</label>
          <div class="small">
            <label><input type="checkbox" class="sec" value="TLDR_MULTILINGUAL" checked> TLDR_MULTILINGUAL</label><br>
            <label><input type="checkbox" class="sec" value="1) Direct Answer" checked> 1) Direct Answer</label><br>
            <label><input type="checkbox" class="sec" value="2) How It‚Äôs Done" checked> 2) How It‚Äôs Done</label><br>
            <label><input type="checkbox" class="sec" value="3) Alternatives" checked> 3) Alternatives</label><br>
            <label><input type="checkbox" class="sec" value="4) Action Plan" checked> 4) Action Plan</label>
          </div>
        </div>
        <div>
          <label>Repo Fence Marker</label>
          <select id="repoFence">
            <option value="```repo">```repo</option>
            <option value="```repository">```repository</option>
          </select>
          <label style="margin-top:8px">File Marker Style</label>
          <select id="fileMarker">
            <option value="// FILE: <path> [lang=<language>]">// FILE: [lang=...]</option>
            <option value="--- FILE: <path> [lang=<language>]">--- FILE: [lang=...]</option>
          </select>
        </div>
        <div>
          <label>Quality / Security Gates</label>
          <div class="small">
            <label><input type="checkbox" class="gate" value="ESLint: no errors; warnings <= {WARNCAP}" checked> ESLint gate</label><br>
            <label><input type="checkbox" class="gate" value="Prettier formatted" checked> Prettier</label><br>
            <label><input type="checkbox" class="gate" value="TypeScript: no errors" checked> TypeScript</label><br>
            <label><input type="checkbox" class="gate" value="Validate & sanitize inputs" checked> Validate/Sanitize</label>
          </div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Acceptance Tests</label>
          <textarea id="accept" class="mono" placeholder="- Frontend builds with npm run build.
- Backend healthcheck 200 on /healthz.
- Unit tests pass: npm test."></textarea>
        </div>
        <div>
          <label>Allowed Deps</label>
          <input id="depsAllowed" type="text" value="zod,dayjs" placeholder="comma-separated">
          <label style="margin-top:6px">Forbidden Deps</label>
          <input id="depsForbidden" type="text" value="eval,Function" placeholder="comma-separated">
        </div>
      </div>
    </div>

    <div class="card">
      <h3>3) Source Files (pick folder or drop)</h3>
      <div class="row">
        <input id="dirpick" type="file" webkitdirectory multiple>
        <input id="filepick" type="file" multiple>
      </div>
      <div id="drop" class="drop">Drag & Drop files here</div>
      <div class="small">Included files:</div>
      <div id="filelist" class="files mono"></div>
      <div class="small">Approx. token estimate: <span id="tok" class="pill">0</span></div>
    </div>

    <div class="card">
      <h3>4) Build Super Prompt</h3>
      <div class="bar" style="margin-bottom:8px">
        <button id="build" class="btn">Build Prompt</button>
        <button id="copy" class="btn secondary">Copy</button>
        <button id="downloadPrompt" class="btn ghost">Download .txt</button>
        <button id="clearPrompt" class="btn ghost">Clear</button>
        <button id="openchat" class="btn ghost" title="Opens ChatGPT in a new tab">Open ChatGPT</button>
      </div>
      <pre id="prompt" class="code mono"></pre>
    </div>

    <div class="card">
      <h3>5) Paste AI Output (repo fence)</h3>
      <textarea id="aiout" class="mono" placeholder="Paste the assistant output that contains ```repo ...```"></textarea>
      <div class="bar" style="margin-top:8px">
        <button id="parse" class="btn">Parse & Diff</button>
        <button id="pickwrite" class="btn secondary" title="Grant write access to a folder for applying changes">Choose Target Folder</button>
      </div>
      <div id="parseStatus" class="small"></div>
      <details open>
        <summary>Changed / New Files</summary>
        <div id="changes" class="filelist"></div>
      </details>
    </div>

    <div class="card">
      <h3>6) Apply Selected Changes</h3>
      <div class="small">Select files below and click <b>Apply</b>. If your browser blocks direct writes, use <i>Download</i> per file.</div>
      <div class="bar" style="margin:8px 0">
        <button id="apply" class="btn">Apply Selected</button>
        <button id="applyAll" class="btn secondary">Apply All</button>
      </div>
      <div id="applyStatus" class="small"></div>
      <div id="diffview" class="diff mono" style="margin-top:10px"></div>
    </div>

    <div class="small">Tip: File System Access API (Chrome/Edge) enables direct writes; otherwise download updated files individually.</div>

  </div>
</div>

<script>
/* VHDR ‚Äî CodingAgent Companion ‚Äî app.js (inline)
 * Version: v1.1.4  |  Build: 2025-09-26  Europe/Warsaw
 * Purpose: One-column UI, advanced options, settings import/export, robust repo parsing, reliable writes. NO template literals anywhere in JS.
 */
(function(){
  var $ = function(s){ return document.querySelector(s); };
  var $$ = function(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); };
  var byId = function(id){ return document.getElementById(id); };
  var nowISO = function(){ return new Date().toISOString(); };

  var state = {
    files: new Map(),
    aiFiles: new Map(),
    writeDir: null,
    settingsKey: 'coding_agent_settings_v114'
  };

  // Self-test & error line
  var selftest = function(){
    var tags = [];
    try {
      tags.push(typeof window.showDirectoryPicker !== 'undefined' ? 'fsapi' : 'nofsapi');
      tags.push(navigator.clipboard ? 'clip' : 'noclip');
      var ok = /```(?:repo|repository)\s*([\s\S]*?)```/m.test('```repo\nx\n```');
      tags.push(ok ? 'parser' : 'noparser');
    } catch (e) { tags.push('err'); }
    var pill = byId('selftest').querySelector('.pill');
    pill.textContent = 'OK ‚úÖ (' + tags.join(', ') + ')';
    pill.style.borderColor = '#2b6';
  };
  var showErr = function(msg){
    var e = byId('errline');
    e.textContent = msg ? ' ‚Äî ' + msg : '';
    e.style.color = msg ? '#ff6b6b' : '';
  };

  // Lang
  var extToLang = function(name){
    var ext = (name.split('.').pop()||'').toLowerCase();
    var map = {html:'html',htm:'html',css:'css',js:'javascript',mjs:'javascript',cjs:'javascript',
               ts:'typescript',tsx:'typescript',jsx:'javascript',json:'json',md:'markdown',
               yml:'yaml',yaml:'yaml',svg:'xml',xml:'xml',sh:'bash',py:'python'};
    return map[ext] || 'text';
  };

  var estimateTokens = function(text){ return Math.ceil((text||'').replace(/\s+/g,' ').length / 4); };

  // Outputs
  var out = {
    list: byId('filelist'),
    tok: byId('tok'),
    prompt: byId('prompt'),
    parseStatus: byId('parseStatus'),
    changes: byId('changes'),
    diffview: byId('diffview'),
    applyStatus: byId('applyStatus')
  };

  // Files
  var renderFileList = function(){
    var lines = [];
    state.files.forEach(function(meta, p){ lines.push(p + '  (' + meta.content.length + ' chars)'); });
    out.list.textContent = lines.length ? lines.join('\n') : '(none)';
  };
  var addFiles = async function(fileList){
    for (var i=0;i<fileList.length;i++){
      var f = fileList[i];
      if (!f || !f.name) continue;
      var path = (f.webkitRelativePath && f.webkitRelativePath.length) ? f.webkitRelativePath : f.name;
      var content = await f.text();
      state.files.set(path, { name: f.name, path: path, content: content, lang: extToLang(f.name) });
    }
    renderFileList();
    updateTokenEstimate();
  };

  // Settings defaults
  var defaults = {
    preset: 'usrp',
    persona: 'concise',
    outlang: 'en',
    repoFence: '```repo',
    fileMarker: '// FILE: <path> [lang=<language>]',
    gates: ['ESLint: no errors; warnings <= {WARNCAP}','Prettier formatted','TypeScript: no errors','Validate & sanitize inputs'],
    accept: '- Frontend builds with npm run build.\n- Backend healthcheck 200 on /healthz.\n- Unit tests pass: npm test.',
    depsAllowed: 'zod,dayjs',
    depsForbidden: 'eval,Function',
    sections: ['TLDR_MULTILINGUAL','1) Direct Answer','2) How It‚Äôs Done','3) Alternatives','4) Action Plan'],
    proj: 'DoAndroidsTrain', license: 'MIT', title: 'Task',
    objective: 'Build/Refactor.', req1: 'Requirement A', req2: 'Requirement B',
    nfr: 'Reasonable performance & UX',
    warncap: 0, devport: 5173, apiport: 3000
  };
  var readForm = function(){
    var sections = $$('.sec').filter(function(x){return x.checked;}).map(function(x){return x.value;});
    var gates = $$('.gate').filter(function(x){return x.checked;}).map(function(x){return x.value;});
    return {
      preset: byId('preset').value,
      persona: byId('persona').value,
      outlang: byId('outlang').value,
      repoFence: byId('repoFence').value,
      fileMarker: byId('fileMarker').value,
      gates: gates,
      accept: byId('accept').value.trim(),
      depsAllowed: byId('depsAllowed').value.trim(),
      depsForbidden: byId('depsForbidden').value.trim(),
      sections: sections,
      proj: byId('proj').value.trim(),
      license: byId('license').value,
      title: byId('title').value.trim(),
      objective: byId('objective').value.trim(),
      req1: byId('req1').value.trim(),
      req2: byId('req2').value.trim(),
      nfr: byId('nfr').value.trim(),
      warncap: Number(byId('warncap').value||0),
      devport: Number(byId('devport').value||5173),
      apiport: Number(byId('apiport').value||3000)
    };
  };
  var writeForm = function(cfg){
    var c = Object.assign({}, defaults, cfg||{});
    byId('preset').value = c.preset;
    byId('persona').value = c.persona;
    byId('outlang').value = c.outlang;
    byId('repoFence').value = c.repoFence;
    byId('fileMarker').value = c.fileMarker;
    byId('accept').value = c.accept;
    byId('depsAllowed').value = c.depsAllowed;
    byId('depsForbidden').value = c.depsForbidden;
    byId('proj').value = c.proj;
    byId('license').value = c.license;
    byId('title').value = c.title;
    byId('objective').value = c.objective;
    byId('req1').value = c.req1;
    byId('req2').value = c.req2;
    byId('nfr').value = c.nfr;
    byId('warncap').value = c.warncap;
    byId('devport').value = c.devport;
    byId('apiport').value = c.apiport;
    $$('.sec').forEach(function(cb){ cb.checked = c.sections.indexOf(cb.value) !== -1; });
    $$('.gate').forEach(function(cb){ cb.checked = c.gates.indexOf(cb.value) !== -1; });
  };
  var saveLocal = function(){ localStorage.setItem(state.settingsKey, JSON.stringify(readForm())); };
  var loadLocal = function(){
    var raw = localStorage.getItem(state.settingsKey);
    if (!raw) return false;
    try { writeForm(JSON.parse(raw)); return true; } catch (e) { return false; }
  };
  var resetDefaults = function(){ writeForm(defaults); };

  var applyPreset = function(key){
    if (key==='usrp'){ byId('persona').value='concise'; byId('outlang').value='en'; $$('.sec').forEach(function(cb){cb.checked=true;}); }
    if (key==='hfsoneshot'){ byId('persona').value='research'; byId('outlang').value='en'; $$('.sec').forEach(function(cb){cb.checked=true;}); }
    if (key==='minimal'){ byId('persona').value='concise'; $$('.sec').forEach(function(cb){ cb.checked = (cb.value==='1) Direct Answer' || cb.value==='4) Action Plan'); }); }
    saveLocal();
  };

  // Prompt builder ‚Äî array join (no template literals)
  var buildPromptText = function(){
    var cfg = readForm();

    // Compose FILES section
    var filesSection = [];
    state.files.forEach(function(meta, path){
      filesSection.push('<<<FILE path="' + path + '" lang="' + meta.lang + '">');
      filesSection.push(meta.content);
      filesSection.push('<<<END FILE>>>');
    });

    var order = cfg.sections.slice();
    var gatesLines = (cfg.gates||[]).map(function(g){ return '- "' + g.replace('{WARNCAP}', String(cfg.warncap)) + '"'; });
    var acceptLines = (cfg.accept||'').split(/\r?\n/).filter(Boolean).map(function(a){ return '- ' + a; });
    var allowed = (cfg.depsAllowed||'').split(',').map(function(s){return s.trim();}).filter(Boolean).map(function(s){return '"'+s+'"';}).join(',');
    var forbidden = (cfg.depsForbidden||'').split(',').map(function(s){return s.trim();}).filter(Boolean).map(function(s){return '"'+s+'"';}).join(',');

    var L = [];
    L.push('===== HFS-OSCAP v1.0.0 ‚Äî HTML5 Full-Stack One-Shot Coding Agent =====');
    L.push('meta:');
    L.push('  model_pref: "GPT-5 Thinking"');
    L.push('  timezone: "Europe/Warsaw"');
    L.push('  default_language: "' + cfg.outlang + '"');
    L.push('  author: "Atlas User"');
    L.push('  prompt_version: "v1.0.0"');
    L.push('  run_date: "' + nowISO().slice(0,10) + '"');
    L.push('');
    L.push('project:');
    L.push('  name: "' + cfg.proj.replace(/"/g,'\\"') + '"');
    L.push('  stack:');
    L.push('    frontend: ["HTML5","CSS3","TypeScript","Vite"]');
    L.push('    backend: ["Node.js 20 LTS","Express 4.x"]');
    L.push('    testing: ["Vitest"]');
    L.push('    quality: ["ESLint","Prettier","TypeCheck (tsc --noEmit)"]');
    L.push('  target_env: ["browser","node"]');
    L.push('  license: "' + cfg.license + '"');
    L.push('');
    L.push('task:');
    L.push('  title: "' + cfg.title.replace(/"/g,'\\"') + '"');
    L.push('  objective: >');
    L.push('    ' + (cfg.objective||'Build/Refactor.'));
    L.push('  requirements:');
    L.push('    - "' + (cfg.req1||'Requirement A').replace(/"/g,'\\"') + '"');
    L.push('    - "' + (cfg.req2||'Requirement B').replace(/"/g,'\\"') + '"');
    L.push('    - "' + (cfg.nfr||'Reasonable performance & UX').replace(/"/g,'\\"') + '"');
    L.push('  acceptance_tests:');
    L.push('    ' + (acceptLines.length? acceptLines.join('\n    ') : '- Frontend builds with npm run build.'));
    L.push('  deliverables:');
    L.push('    - "COMPLETE REPO inside one code-fence (see OUTPUT CONTRACT)."');
    L.push('    - "README with Quickstart."');
    L.push('    - "Automated tests."');
    L.push('    - "CHANGELOG.md + per-file VHDR."');
    L.push('    - "Complexity & risk notes."');
    L.push('');
    L.push('constraints:');
    L.push('  comments_policy: "Minimal‚Äîonly VHDR + essential TODOs."');
    L.push('  version_header:');
    L.push('    pattern: |');
    L.push('      /*');
    L.push('       * VHDR ‚Äî ' + cfg.proj.replace(/[\*]/g,'\\*') + ' ‚Äî <RELATIVE_PATH>');
    L.push('       * Version: <semver>  |  Build: ' + nowISO().slice(0,16).replace('T',' ') + ' Europe/Warsaw');
    L.push('       * Purpose: <one-line purpose>');
    L.push('       * Changelog (latest first):');
    L.push('       * - <semver>: <concise change>');
    L.push('       * - <prev>: <prior change>');
    L.push('       */');
    L.push('  deps:');
    L.push('    allowed: [' + allowed + ']');
    L.push('    forbidden: [' + forbidden + ']');
    L.push('  security:');
    L.push('    - "No secrets/hardcoding; use env."');
    L.push('    - "Validate & sanitize inputs."');
    L.push('    - "CSP (frontend), helmet (backend)."');
    L.push('  quality_gates:');
    L.push('    ' + (gatesLines.length? gatesLines.join('\n    '): '- "Prettier formatted"'));
    L.push('  syntax_gate:');
    L.push('    - "Repo must be syntactically valid and runnable."');
    L.push('  accessibility: "WCAG 2.1 AA basics."');
    L.push('');
    L.push('output_contract:');
    L.push('  order:');
    order.forEach(function(x){ L.push('    - "' + String(x).replace(/"/g,'\\"') + '"'); });
    L.push('    - "--- ARTIFACTS START ---"');
    L.push('    - "```repo ... (files) ... ```"');
    L.push('    - "--- ARTIFACTS END ---"');
    L.push('  repo_fence: "' + (cfg.repoFence||'```repo') + '"');
    L.push('  file_markers:');
    L.push('    start: "' + (cfg.fileMarker||'// FILE: <path> [lang=<language>]').replace(/</g,'\\u003C') + '"');
    L.push('    end: "// END FILE"');
    L.push('  notes:');
    L.push('    - "Emit a complete, runnable repository with scripts."');
    L.push('    - "Use minimal comments beyond VHDR."');
    L.push('    - "If fixing bugs, also include an MRE under tests/."');
    L.push('');
    L.push('FILES:');
    L.push(filesSection.length ? filesSection.join('\n') : '  # (none provided)');
    L.push('');
    L.push('EXECUTION_REQUEST:');
    L.push('  output_language: "' + cfg.outlang + '"');
    L.push('  persona_style: "' + cfg.persona + '"');
    L.push('  verbosity: "concise"');
    L.push('  test_framework: "vitest"');
    L.push('  dev_server_port: ' + cfg.devport);
    L.push('  api_port: ' + cfg.apiport);
    L.push('  build_command: "npm run build"');
    L.push('  run_command: "npm run dev && npm run dev:server"');
    L.push('  test_command: "npm test"');
    L.push('');
    L.push('FINAL_INSTRUCTIONS:');
    L.push('  - "Honor OUTPUT CONTRACT strictly."');
    L.push('  - "Every file begins with a VHDR block and a mini-changelog."');
    L.push('  - "Keep inline comments minimal elsewhere."');
    L.push('  - "Emit the complete repo inside a single ```repo code fence using file markers."');
    L.push('  - "After artifacts, stop."');
    L.push('===== END HFS-OSCAP =====');

    return L.join('\n');
  };

  var updateTokenEstimate = function(){
    var txt = buildPromptText();
    out.tok.textContent = estimateTokens(txt).toLocaleString();
  };

  // Diff
  var diffLines = function(a,b){
    var A = (a||'').split(/\r?\n/), B = (b||'').split(/\r?\n/);
    var n=A.length, m=B.length;
    var dp = new Array(n+1); for(var i=0;i<=n;i++){ dp[i]=new Array(m+1).fill(0); }
    for(var i1=1;i1<=n;i1++) for(var j1=1;j1<=m;j1++) dp[i1][j1] = (A[i1-1]===B[j1-1]) ? dp[i1-1][j1-1]+1 : Math.max(dp[i1-1][j1],dp[i1][j1-1]);
    var ops=[], i=n, j=m;
    while(i>0||j>0){
      if(i>0&&j>0&&A[i-1]===B[j-1]){ ops.push([' ',A[i-1]]); i--; j--; }
      else if(j>0 && (i===0 || dp[i][j-1]>=dp[i-1][j])){ ops.push(['+',B[j-1]]); j--; }
      else { ops.push(['-',A[i-1]]); i--; }
    }
    return ops.reverse();
  };

  // Parser
  function parseRepoFence(text){
    if(!text) return { ok:false, msg:'Empty input.' };
    var fence = /```(?:repo|repository)\s*([\s\S]*?)```/m.exec(text);
    if(!fence) return { ok:false, msg:'No ```repo fence found.' };
    var block = fence[1];
    var fileRe = /^(?:\/\/|---)\s*FILE:\s*([^\[\r\n]+?)(?:\s+\[lang=([^\]]+)\])?\s*[\r\n]+([\s\S]*?)(?=^(?:\/\/|---)\s*END FILE\s*$|$)/gm;
    var results = new Map();
    var m;
    while((m = fileRe.exec(block)) !== null){
      var path = (m[1]||'').trim();
      var lang = (m[2]||'text').trim();
      var content = (m[3]||'');
      if(path) results.set(path, { path: path, lang: lang, content: content });
    }
    return results.size ? { ok:true, files:results } : { ok:false, msg:'No files found inside repo fence.' };
  }

  var renderChanges = function(){
    out.changes.innerHTML = '';
    state.aiFiles.forEach(function(ai, path){
      var orig = state.files.get(path) ? state.files.get(path).content : '';
      var ops = diffLines(orig, ai.content);
      var changed = ops.some(function(op){ return op[0] !== ' '; });

      var card = document.createElement('div');
      card.className = 'card';
      card.style.background = '#0e141a';

      var bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.alignItems = 'center';

      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.path = path;
      if (changed) cb.checked = true;

      var info = document.createElement('div');
      info.style.flex = '1';

      var b = document.createElement('b');
      b.textContent = path;
      info.appendChild(b);

      var statusSpan = document.createElement('span');
      statusSpan.className = 'pill ' + (changed ? 'warn' : 'ok');
      statusSpan.textContent = changed ? 'changed' : 'new/unchanged';
      statusSpan.style.marginLeft = '8px';
      info.appendChild(statusSpan);

      var tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = 'lang=' + ai.lang;
      tag.style.marginLeft = '8px';
      info.appendChild(tag);

      var btnShow = document.createElement('button');
      btnShow.className = 'btn ghost small';
      btnShow.textContent = 'Show Diff';
      btnShow.dataset.show = path;

      var btnDl = document.createElement('button');
      btnDl.className = 'btn ghost small';
      btnDl.textContent = 'Download';
      btnDl.dataset.dl = path;

      bar.appendChild(cb);
      bar.appendChild(info);
      bar.appendChild(btnShow);
      bar.appendChild(btnDl);
      card.appendChild(bar);
      out.changes.appendChild(card);
    });
  };

  var ensureDir = async function(dirHandle, path){
    var parts = path.split('/'); parts.pop();
    var cur = dirHandle;
    for (var i=0;i<parts.length;i++){
      var folder = parts[i];
      if (!folder) continue;
      cur = await cur.getDirectoryHandle(folder, { create:true });
    }
    return cur;
  };
  var writeFile = async function(dirHandle, path, content){
    var dir = await ensureDir(dirHandle, path);
    var name = path.split('/').pop();
    var fileHandle = await dir.getFileHandle(name, { create:true });
    var ws = await fileHandle.createWritable();
    await ws.write(content);
    await ws.close();
  };

  var tryBuild = function(){
    try {
      out.prompt.textContent = buildPromptText();
      updateTokenEstimate();
      showErr('');
    } catch (e) {
      out.prompt.textContent = '';
      showErr('Build error: ' + (e && e.message ? e.message : e));
      console.error(e);
    }
  };

  // Events
  byId('dirpick').addEventListener('change', function(e){ addFiles(e.target.files); });
  byId('filepick').addEventListener('change', function(e){ addFiles(e.target.files); });

  var drop = byId('drop');
  drop.addEventListener('dragover', function(e){ e.preventDefault(); drop.style.background='#0c1520'; });
  drop.addEventListener('dragleave', function(){ drop.style.background=''; });
  drop.addEventListener('drop', function(e){
    e.preventDefault(); drop.style.background='';
    if (e.dataTransfer.files && e.dataTransfer.files.length) { addFiles(e.dataTransfer.files); }
  });

  byId('build').addEventListener('click', function(){ tryBuild(); saveLocal(); });
  byId('copy').addEventListener('click', async function(){
    var txt = out.prompt.textContent || buildPromptText();
    if (navigator.clipboard && navigator.clipboard.writeText) { await navigator.clipboard.writeText(txt); alert('Prompt copied to clipboard.'); }
    else { showErr('Clipboard API unavailable'); }
  });
  byId('downloadPrompt').addEventListener('click', function(){
    var txt = out.prompt.textContent || buildPromptText();
    var blob = new Blob([txt], {type:'text/plain'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'super-prompt.txt';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  byId('clearPrompt').addEventListener('click', function(){ out.prompt.textContent = ''; });
  byId('openchat').addEventListener('click', function(){ window.open('https://chat.openai.com', '_blank'); });

  byId('parse').addEventListener('click', function(){
    var raw = byId('aiout').value;
    var parsed = parseRepoFence(raw);
    if (!parsed.ok) { out.parseStatus.innerHTML = '<span class="bad">Parse error:</span> ' + parsed.msg; return; }
    state.aiFiles = parsed.files;
    out.parseStatus.innerHTML = '<span class="ok">Parsed ' + parsed.files.size + ' file(s).</span>';
    renderChanges();
  });

  byId('pickwrite').addEventListener('click', async function(){
    if (!window.showDirectoryPicker) { alert('File System Access API not supported in this browser.'); return; }
    state.writeDir = await window.showDirectoryPicker({ mode:'readwrite' });
    out.applyStatus.innerHTML = '<span class="ok">Write access granted.</span>';
  });

  var collectSelected = function(){
    var selected = [];
    $$('#changes input[type=checkbox]').forEach(function(cb){ if (cb.checked) selected.push(cb.dataset.path); });
    return selected;
  };

  byId('apply').addEventListener('click', async function(){
    if (!state.writeDir) { alert('Choose a target folder first.'); return; }
    var paths = collectSelected();
    if (!paths.length) { alert('No files selected.'); return; }
    for (var i=0;i<paths.length;i++){
      var p = paths[i];
      await writeFile(state.writeDir, p, state.aiFiles.get(p).content);
    }
    out.applyStatus.innerHTML = '<span class="ok">Applied ' + paths.length + ' file(s).</span>';
  });

  byId('applyAll').addEventListener('click', async function(){
    if (!state.writeDir) { alert('Choose a target folder first.'); return; }
    var count = 0;
    state.aiFiles.forEach(async function(file, p){ await writeFile(state.writeDir, p, file.content); count++; });
    out.applyStatus.innerHTML = '<span class="ok">Applied ' + count + ' file(s).</span>';
  });

  byId('preset').addEventListener('change', function(e){ applyPreset(e.target.value); tryBuild(); });
  ['persona','outlang','repoFence','fileMarker','accept','depsAllowed','depsForbidden','proj','license','title','objective','req1','req2','nfr','warncap','devport','apiport']
    .forEach(function(id){ byId(id).addEventListener('input', function(){ saveLocal(); }); });
  $$('.sec').forEach(function(cb){ cb.addEventListener('change', function(){ saveLocal(); }); });
  $$('.gate').forEach(function(cb){ cb.addEventListener('change', function(){ saveLocal(); }); });

  byId('saveLocal').addEventListener('click', function(){ saveLocal(); alert('Saved to localStorage.'); });
  byId('loadLocal').addEventListener('click', function(){ var ok = loadLocal(); if(!ok) alert('No saved settings.'); tryBuild(); });
  byId('resetDefaults').addEventListener('click', function(){ resetDefaults(); saveLocal(); tryBuild(); });
  byId('importJSON').addEventListener('click', function(){ byId('importFile').click(); });
  byId('importFile').addEventListener('change', async function(e){
    var f = e.target.files && e.target.files[0]; if(!f) return;
    try { var txt = await f.text(); var cfg = JSON.parse(txt); writeForm(cfg); saveLocal(); tryBuild(); }
    catch (err) { alert('Invalid JSON.'); }
    e.target.value = '';
  });
  byId('exportJSON').addEventListener('click', function(){
    var cfg = readForm();
    var blob = new Blob([JSON.stringify(cfg,null,2)], {type:'application/json'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'coding-agent-settings.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Init
  resetDefaults();
  loadLocal();
  selftest();
  tryBuild(); // auto-build
})();
</script>
</body>
</html>
