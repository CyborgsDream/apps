<!-- Mindful Meditation Generator v0.0.6 -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mindful Meditation Generator - Multi-Language</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap');
        
        :root {
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --accent-orange: #FF6B00;
            --light-blue: #dbeafe;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #3b82f6 0%, #1e3a8a 55%, #111827 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 500px;
            height: 500px;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.6;
            pointer-events: none;
            z-index: 0;
        }

        body::before {
            top: -150px;
            left: -120px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.6), transparent 70%);
        }

        body::after {
            bottom: -180px;
            right: -140px;
            background: radial-gradient(circle, rgba(255, 107, 0, 0.45), transparent 70%);
        }

        .glass-morphism {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.22), rgba(255, 255, 255, 0.08));
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.35);
            position: relative;
            overflow: hidden;
        }

        .glass-morphism::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.25), transparent 65%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .glass-morphism:hover::before {
            opacity: 1;
        }

        .meditation-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: linear-gradient(160deg, rgba(30, 58, 138, 0.75), rgba(59, 130, 246, 0.3));
            border: 1px solid rgba(148, 163, 184, 0.3);
            box-shadow: 0 20px 35px rgba(15, 23, 42, 0.35);
            transform-style: preserve-3d;
        }

        .meditation-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.25), transparent 55%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .meditation-card:hover {
            transform: translateY(-10px) rotateX(5deg);
            box-shadow: 0 30px 50px rgba(15, 23, 42, 0.45);
        }

        .meditation-card:hover::after {
            opacity: 1;
        }

        .meditation-card.selected {
            border: 2px solid rgba(255, 107, 0, 0.7);
            box-shadow: 0 35px 60px rgba(255, 107, 0, 0.25);
        }
        
        .volume-slider {
            -webkit-appearance: none;
            appearance: none;
            height: 10px;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.4), rgba(255, 255, 255, 0.25));
            outline: none;
            box-shadow: inset 0 3px 6px rgba(15, 23, 42, 0.45);
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ff9350, #ff6b00);
            cursor: pointer;
            box-shadow: 0 8px 18px rgba(255, 107, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.6);
        }
        
        .playing-indicator {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .wave-animation {
            animation: wave 3s ease-in-out infinite;
        }
        
        @keyframes wave {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .cuecard {
            transition: all 0.5s ease;
            transform: translateY(20px);
            opacity: 0;
        }
        
        .cuecard.active {
            transform: translateY(0);
            opacity: 1;
        }
        
        .language-btn,
        .nature-sound-btn,
        .control-btn,
        .cuecard-nav-btn {
            transition: transform 0.25s ease, box-shadow 0.25s ease, background 0.25s ease;
            position: relative;
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.05));
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.25);
            border: 1px solid rgba(148, 163, 184, 0.25);
            backdrop-filter: blur(6px);
        }

        .language-btn:hover,
        .nature-sound-btn:hover,
        .control-btn:not(:disabled):hover,
        .cuecard-nav-btn:not(:disabled):hover {
            transform: translateY(-4px);
            box-shadow: 0 18px 30px rgba(15, 23, 42, 0.35);
        }

        .language-btn.active,
        .nature-sound-btn.selected,
        .control-btn:focus-visible {
            background: linear-gradient(150deg, rgba(255, 107, 0, 0.85), rgba(255, 147, 80, 0.75));
            box-shadow: 0 20px 35px rgba(255, 107, 0, 0.35);
        }

        .language-btn.active::after,
        .nature-sound-btn.selected::after {
            content: '';
            position: absolute;
            inset: 2px;
            border-radius: inherit;
            border: 1px solid rgba(255, 255, 255, 0.35);
            opacity: 0.9;
            pointer-events: none;
        }
        
        .breathing-circle {
            animation: breathe 4s ease-in-out infinite;
        }
        
        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: linear-gradient(150deg, rgba(59, 130, 246, 0.2), rgba(30, 58, 138, 0.05));
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: 0 18px 35px rgba(15, 23, 42, 0.3);
            position: relative;
            overflow: hidden;
        }

        .feature-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top left, rgba(255, 255, 255, 0.4), transparent 55%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 45px rgba(15, 23, 42, 0.35);
        }

        .feature-card:hover::after {
            opacity: 1;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-content {
            background: rgba(255, 255, 255, 0.9);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--accent-orange);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .control-btn:active {
            transform: translateY(0) scale(0.98);
            box-shadow: 0 10px 18px rgba(15, 23, 42, 0.3);
        }
        
        .play-btn {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.6), rgba(255, 107, 0, 0.95));
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 25px 45px rgba(255, 107, 0, 0.45), inset 0 -6px 12px rgba(15, 23, 42, 0.2);
            position: relative;
        }

        .play-btn::after {
            content: '';
            position: absolute;
            inset: 10px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.45);
            box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.4);
        }

        .play-btn:hover {
            transform: translateY(-6px) scale(1.05);
            box-shadow: 0 30px 55px rgba(255, 107, 0, 0.55), inset 0 -6px 12px rgba(15, 23, 42, 0.2);
        }

        .progress-container {
            position: relative;
            height: 8px;
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.7), rgba(59, 130, 246, 0.4));
            border-radius: 999px;
            overflow: hidden;
            box-shadow: inset 0 4px 8px rgba(15, 23, 42, 0.5);
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: linear-gradient(90deg, rgba(255, 107, 0, 0.8), rgba(255, 255, 255, 0.8));
            border-radius: 999px;
            transition: width 0.3s ease;
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.5);
        }
        
        .cuecard-container {
            max-height: 150px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-orange) rgba(255, 255, 255, 0.2);
        }
        
        .cuecard-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .cuecard-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
        
        .cuecard-container::-webkit-scrollbar-thumb {
            background: var(--accent-orange);
            border-radius: 3px;
        }
        
        .cuecard-nav-btn {
            color: white;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .cuecard-nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .cuecard-nav-btn:disabled:hover {
            transform: none;
            box-shadow: 0 12px 20px rgba(15, 23, 42, 0.2);
        }
        
        .time-marker {
            position: absolute;
            top: -20px;
            transform: translateX(-50%);
            font-size: 10px;
            color: white;
            opacity: 0.7;
        }
        
        /* Visualizer Styles */
        .visualizer-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            z-index: 10;
            pointer-events: none;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent);
        }
        
        #visualizer {
            width: 100%;
            height: 100%;
        }
        
        .visualizer-bar {
            position: absolute;
            bottom: 0;
            background: linear-gradient(to top, var(--accent-orange), rgba(255, 107, 0, 0.3));
            border-radius: 2px 2px 0 0;
            transition: height 0.1s ease;
            box-shadow: 0 0 10px rgba(255, 107, 0, 0.5);
        }
    </style>
</head>
<body class="overflow-x-hidden">
    <!-- Audio Visualizer -->
    <div class="visualizer-container">
        <canvas id="visualizer"></canvas>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 class="text-xl font-medium text-gray-800 mb-2">Preparing Your Meditation</h3>
            <p class="text-gray-600">Initializing audio components and voice synthesis...</p>
        </div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-5xl font-light text-white mb-4">
                <i class="fas fa-spa mr-3"></i>Mindful Meditation Generator
            </h1>
            <p class="text-xl text-white opacity-80">Multi-language guided meditation with binaural beats</p>
            <div class="mt-2 text-white opacity-60">v0.0.6</div>
        </div>

        <!-- Language Selector -->
        <div class="glass-morphism rounded-2xl p-4 mb-8">
            <h3 class="text-white font-medium mb-3 text-center">
                <i class="fas fa-globe mr-2"></i>Select Language
            </h3>
            <div class="flex flex-wrap justify-center gap-3">
                <button class="language-btn glass-morphism rounded-lg px-4 py-2 text-white text-sm active" data-lang="en">
                    <i class="fas fa-flag-usa mr-2"></i>English
                </button>
                <button class="language-btn glass-morphism rounded-lg px-4 py-2 text-white text-sm" data-lang="de">
                    <i class="fas fa-flag mr-2"></i>Deutsch
                </button>
                <button class="language-btn glass-morphism rounded-lg px-4 py-2 text-white text-sm" data-lang="nl">
                    <i class="fas fa-flag mr-2"></i>Nederlands
                </button>
                <button class="language-btn glass-morphism rounded-lg px-4 py-2 text-white text-sm" data-lang="af">
                    <i class="fas fa-flag mr-2"></i>Afrikaans
                </button>
                <button class="language-btn glass-morphism rounded-lg px-4 py-2 text-white text-sm" data-lang="pl">
                    <i class="fas fa-flag mr-2"></i>Polski
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Panel - Meditation Types -->
            <div class="lg:col-span-2">
                <div class="glass-morphism rounded-2xl p-6 mb-6">
                    <h2 class="text-2xl font-medium text-white mb-6">
                        <i class="fas fa-leaf mr-2"></i>Choose Your Meditation
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="meditation-card glass-morphism rounded-xl p-6 text-white" data-type="relaxation">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-cloud text-3xl mr-4 text-blue-200"></i>
                                <h3 class="text-xl font-medium">Deep Relaxation</h3>
                            </div>
                            <p class="text-sm opacity-80">Release tension and find deep peace</p>
                            <div class="mt-4 text-xs opacity-60">
                                <i class="fas fa-clock mr-1"></i>15 minutes
                            </div>
                        </div>
                        
                        <div class="meditation-card glass-morphism rounded-xl p-6 text-white" data-type="sleep">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-moon text-3xl mr-4 text-purple-200"></i>
                                <h3 class="text-xl font-medium">Sleep Journey</h3>
                            </div>
                            <p class="text-sm opacity-80">Drift into peaceful slumber</p>
                            <div class="mt-4 text-xs opacity-60">
                                <i class="fas fa-clock mr-1"></i>20 minutes
                            </div>
                        </div>
                        
                        <div class="meditation-card glass-morphism rounded-xl p-6 text-white" data-type="focus">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-brain text-3xl mr-4 text-green-200"></i>
                                <h3 class="text-xl font-medium">Mental Focus</h3>
                            </div>
                            <p class="text-sm opacity-80">Enhance concentration and clarity</p>
                            <div class="mt-4 text-xs opacity-60">
                                <i class="fas fa-clock mr-1"></i>12 minutes
                            </div>
                        </div>
                        
                        <div class="meditation-card glass-morphism rounded-xl p-6 text-white" data-type="stress">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-heart text-3xl mr-4 text-pink-200"></i>
                                <h3 class="text-xl font-medium">Stress Relief</h3>
                            </div>
                            <p class="text-sm opacity-80">Release anxiety and find calm</p>
                            <div class="mt-4 text-xs opacity-60">
                                <i class="fas fa-clock mr-1"></i>18 minutes
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio Controls -->
                <div class="glass-morphism rounded-2xl p-6 mb-6">
                    <h2 class="text-2xl font-medium text-white mb-6">
                        <i class="fas fa-sliders-h mr-2"></i>Audio Settings
                    </h2>
                    
                    <div class="space-y-6">
                        <!-- Voice Volume -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-white font-medium">
                                    <i class="fas fa-microphone mr-2"></i>Voice Volume
                                </label>
                                <span class="text-white opacity-80" id="voiceVolumeValue">70%</span>
                            </div>
                            <input type="range" class="volume-slider w-full" id="voiceVolume" min="0" max="100" value="70">
                            <div class="mt-4">
                                <label class="text-white font-medium block mb-2">
                                    <i class="fas fa-headphones mr-2"></i>Guided Voice Style
                                </label>
                                <select id="voiceStyleSelect" class="w-full bg-white bg-opacity-10 border border-white border-opacity-20 text-white rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-orange-400">
                                </select>
                                <p id="voiceStyleDescription" class="text-sm text-blue-100 mt-2 opacity-80"></p>
                            </div>
                        </div>
                        
                        <!-- Nature Sounds Volume -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-white font-medium">
                                    <i class="fas fa-tree mr-2"></i>Nature Sounds
                                </label>
                                <span class="text-white opacity-80" id="natureVolumeValue">50%</span>
                            </div>
                            <input type="range" class="volume-slider w-full" id="natureVolume" min="0" max="100" value="50">
                        </div>
                        
                        <!-- Binaural Beats Volume -->
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-white font-medium">
                                    <i class="fas fa-wave-square mr-2"></i>Binaural Beats
                                </label>
                                <span class="text-white opacity-80" id="binauralVolumeValue">30%</span>
                            </div>
                            <input type="range" class="volume-slider w-full" id="binauralVolume" min="0" max="100" value="30">
                        </div>
                        
                        <!-- Nature Sound Selection -->
                        <div>
                            <label class="text-white font-medium block mb-3">
                                <i class="fas fa-music mr-2"></i>Nature Background
                            </label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <button class="nature-sound-btn glass-morphism rounded-lg p-3 text-white text-sm" data-sound="rain">
                                    <i class="fas fa-cloud-rain mb-1"></i><br>Rain
                                </button>
                                <button class="nature-sound-btn glass-morphism rounded-lg p-3 text-white text-sm" data-sound="ocean">
                                    <i class="fas fa-water mb-1"></i><br>Ocean
                                </button>
                                <button class="nature-sound-btn glass-morphism rounded-lg p-3 text-white text-sm" data-sound="forest">
                                    <i class="fas fa-tree mb-1"></i><br>Forest
                                </button>
                                <button class="nature-sound-btn glass-morphism rounded-lg p-3 text-white text-sm" data-sound="birds">
                                    <i class="fas fa-dove mb-1"></i><br>Birds
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Features -->
                <div class="glass-morphism rounded-2xl p-6">
                    <h2 class="text-2xl font-medium text-white mb-6">
                        <i class="fas fa-magic mr-2"></i>Enhanced Features
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="feature-card glass-morphism rounded-lg p-4 text-white text-center">
                            <i class="fas fa-eye text-2xl mb-2 text-blue-200"></i>
                            <h4 class="font-medium mb-1">Visual Breathing</h4>
                            <p class="text-xs opacity-80">Guided breathing animation</p>
                        </div>
                        
                        <div class="feature-card glass-morphism rounded-lg p-4 text-white text-center">
                            <i class="fas fa-closed-captioning text-2xl mb-2 text-green-200"></i>
                            <h4 class="font-medium mb-1">Live Cuecards</h4>
                            <p class="text-xs opacity-80">Real-time text display</p>
                        </div>
                        
                        <div class="feature-card glass-morphism rounded-lg p-4 text-white text-center">
                            <i class="fas fa-language text-2xl mb-2 text-purple-200"></i>
                            <h4 class="font-medium mb-1">5 Languages</h4>
                            <p class="text-xs opacity-80">Multi-language support</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Player & Status -->
            <div class="lg:col-span-1">
                <!-- Player Status -->
                <div class="glass-morphism rounded-2xl p-6 mb-6">
                    <div class="text-center">
                        <div class="flex justify-center mb-4">
                            <div class="play-btn" id="playPauseBtn">
                                <i class="fas fa-play text-3xl text-white" id="playPauseIcon"></i>
                            </div>
                        </div>
                        <h3 class="text-xl font-medium text-white mb-2" id="currentSession">Ready to Begin</h3>
                        <p class="text-white opacity-80 text-sm" id="sessionDescription">Select a meditation type</p>
                        
                        <!-- Enhanced Progress Bar -->
                        <div class="mt-6">
                            <div class="flex justify-between text-xs text-white opacity-60 mb-1">
                                <span id="currentTime">0:00</span>
                                <span id="totalTime">0:00</span>
                            </div>
                            <div class="progress-container" id="progressContainer">
                                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                                <!-- Time markers -->
                                <div class="time-marker" style="left: 25%">25%</div>
                                <div class="time-marker" style="left: 50%">50%</div>
                                <div class="time-marker" style="left: 75%">75%</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Breathing Animation -->
                <div class="glass-morphism rounded-2xl p-6 mb-6">
                    <h3 class="text-white font-medium mb-4 text-center">
                        <i class="fas fa-wind mr-2"></i>Breathing Guide
                    </h3>
                    <div class="flex justify-center">
                        <div class="w-32 h-32 rounded-full bg-gradient-to-r from-blue-400 to-purple-500 opacity-30 breathing-circle hidden" id="breathingCircle"></div>
                    </div>
                    <p class="text-white text-center text-sm mt-4 opacity-80" id="breathingText">Breathe naturally</p>
                </div>

                <!-- Cuecard Display -->
                <div class="glass-morphism rounded-2xl p-6 mb-6">
                    <h3 class="text-white font-medium mb-4 text-center">
                        <i class="fas fa-closed-captioning mr-2"></i>Current Cuecard
                    </h3>
                    <div class="cuecard-container glass-morphism rounded-lg p-4 min-h-[100px] flex items-center justify-center mb-3" id="cuecard">
                        <p class="text-white text-center text-sm" id="cuecardText">Meditation guidance will appear here</p>
                    </div>
                    <div class="flex justify-between">
                        <button class="cuecard-nav-btn" id="prevCuecardBtn" disabled>
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span class="text-white text-sm opacity-70" id="cuecardCounter">0 / 0</span>
                        <button class="cuecard-nav-btn" id="nextCuecardBtn" disabled>
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="glass-morphism rounded-2xl p-6">
                    <div class="space-y-4">
                        <button id="startBtn" class="control-btn w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-medium py-3 px-6 rounded-xl transition-all">
                            <i class="fas fa-play mr-2"></i>Start Meditation
                        </button>
                        <button id="pauseBtn" class="control-btn w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-medium py-3 px-6 rounded-xl transition-all" disabled>
                            <i class="fas fa-pause mr-2"></i>Pause
                        </button>
                        <button id="stopBtn" class="control-btn w-full bg-red-500 bg-opacity-20 hover:bg-opacity-30 text-white font-medium py-3 px-6 rounded-xl transition-all" disabled>
                            <i class="fas fa-stop mr-2"></i>Stop
                        </button>
                    </div>
                    
                    <!-- Binaural Frequency Info -->
                    <div class="mt-6 p-4 bg-white bg-opacity-10 rounded-xl">
                        <h4 class="text-white font-medium mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Binaural Frequency
                        </h4>
                        <p class="text-white opacity-80 text-sm" id="frequencyInfo">Select meditation type to see frequency</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MeditationGenerator {
            constructor() {
                this.audioContext = null;
                this.isPlaying = false;
                this.isPaused = false;
                this.currentMeditation = null;
                this.selectedNatureSound = 'rain';
                this.voiceVolume = 0.7;
                this.natureVolume = 0.5;
                this.binauralVolume = 0.3;
                this.currentLanguage = 'en';
                this.currentCuecardIndex = 0;
                this.startTime = 0;
                this.pausedTime = 0;
                this.analyser = null;
                this.dataArray = null;
                this.visualizerBars = [];
                this.speechTimeouts = [];
                this.voiceDelayNode = null;
                this.voiceEchoGain = null;
                this.voiceGain = null;
                this.voiceQueue = [];
                this.voiceScript = [];
                this.currentVoiceSource = null;
                this.voiceClipCache = new Map();
                this.useBrowserSpeechFallback = false;
                this.activeVoiceRequestId = 0;

                this.voiceProfiles = {
                    en: [
                        { id: 'Amy', label: 'Amy · Warm English', description: 'Gentle, reassuring tone with a soft British accent.' },
                        { id: 'Matthew', label: 'Matthew · Calm English', description: 'Grounded and calm North American voice ideal for mindfulness.' },
                        { id: 'Joanna', label: 'Joanna · Soft English', description: 'Soothing, balanced narration perfect for evening sessions.' }
                    ],
                    de: [
                        { id: 'Vicki', label: 'Vicki · Sanfte Deutsch', description: 'Quiet, encouraging German voice with a friendly cadence.' },
                        { id: 'Hans', label: 'Hans · Ruhige Deutsch', description: 'Deep, peaceful German narration with steady pacing.' }
                    ],
                    nl: [
                        { id: 'Lotte', label: 'Lotte · Zachte Nederlands', description: 'Light and supportive Dutch voice for gentle guidance.' },
                        { id: 'Ruben', label: 'Ruben · Rustige Nederlands', description: 'Warm Dutch baritone that remains calm and clear.' }
                    ],
                    af: [
                        { id: 'Tiana', label: 'Tiana · Sagte Afrikaans', description: 'Soft Afrikaans narration designed for deep relaxation.' }
                    ],
                    pl: [
                        { id: 'Maja', label: 'Maja · Delikatny Polski', description: 'Delicate Polish guidance with a nurturing tone.' },
                        { id: 'Jacek', label: 'Jacek · Spokojny Polski', description: 'Smooth Polish baritone that feels grounded and safe.' }
                    ]
                };

                this.selectedVoice = this.voiceProfiles[this.currentLanguage][0].id;

                this.natureSoundSource = null;
                this.natureGainNode = null;
                this.natureBuffers = {};
                this.natureSoundMap = {
                    rain: 'https://assets.mixkit.co/sfx/preview/mixkit-light-rain-loop-2391.mp3',
                    ocean: 'https://assets.mixkit.co/sfx/preview/mixkit-ocean-waves-1190.mp3',
                    forest: 'https://assets.mixkit.co/sfx/preview/mixkit-forest-birds-ambience-1214.mp3',
                    birds: 'https://assets.mixkit.co/sfx/preview/mixkit-small-birds-loop-2393.mp3'
                };

                this.binauralGainNodes = [];
                this.binauralOscillators = [];

                this.meditationScripts = {
                    en: {
                        relaxation: {
                            name: "Deep Relaxation",
                            duration: 900,
                            frequency: "4-7 Hz (Theta)",
                            script: [
                                "Welcome to your deep relaxation meditation. Find a comfortable position and close your eyes.",
                                "Take a deep breath in through your nose, and slowly exhale through your mouth.",
                                "Feel the tension melting away from your shoulders and neck.",
                                "Imagine yourself floating on a peaceful cloud, weightless and free.",
                                "With each breath, you sink deeper into a state of complete relaxation.",
                                "Your mind becomes calm, like a still lake reflecting the peaceful sky.",
                                "Every muscle in your body is now completely relaxed.",
                                "You are safe, you are peaceful, you are completely at ease.",
                                "Enjoy this moment of deep tranquility.",
                                "When you're ready, slowly bring your awareness back to the present moment."
                            ]
                        },
                        sleep: {
                            name: "Sleep Journey",
                            duration: 1200,
                            frequency: "2-4 Hz (Delta)",
                            script: [
                                "Welcome to your sleep journey meditation. Lie down comfortably and prepare for rest.",
                                "Let your eyes grow heavy as you listen to my voice.",
                                "Imagine yourself sinking into a soft, comfortable bed.",
                                "Each breath takes you deeper into relaxation.",
                                "Your thoughts become like gentle clouds, drifting by without attachment.",
                                "You are entering a state of deep, peaceful rest.",
                                "Sleep is coming naturally and easily to you now.",
                                "Drift peacefully into sweet dreams."
                            ]
                        },
                        focus: {
                            name: "Mental Focus",
                            duration: 720,
                            frequency: "8-12 Hz (Alpha)",
                            script: [
                                "Welcome to your mental focus meditation. Sit comfortably with your back straight.",
                                "Bring your attention to your breath, noticing each inhale and exhale.",
                                "When thoughts arise, gently acknowledge them and return to your breath.",
                                "Imagine your mind as a clear, calm lake.",
                                "Your focus becomes sharper with each moment of awareness.",
                                "You are completely present, here and now.",
                                "Your mind is clear, focused, and alert.",
                                "You have the ability to concentrate deeply on what matters."
                            ]
                        },
                        stress: {
                            name: "Stress Relief",
                            duration: 1080,
                            frequency: "5-8 Hz (Theta)",
                            script: [
                                "Welcome to your stress relief meditation. Take a moment to settle in comfortably.",
                                "Acknowledge any stress or tension you're feeling without judgment.",
                                "Take a deep breath in, and as you exhale, imagine releasing that stress.",
                                "Visualize the stress leaving your body like dark smoke.",
                                "With each breath, you feel lighter and more peaceful.",
                                "Your shoulders relax, your jaw unclenches, your brow smooths.",
                                "You are letting go of worry and embracing calm.",
                                "You are safe, you are calm, you are at peace."
                            ]
                        }
                    },
                    de: {
                        relaxation: {
                            name: "Tiefe Entspannung",
                            duration: 900,
                            frequency: "4-7 Hz (Theta)",
                            script: [
                                "Willkommen zu Ihrer tiefen Entspannungsmeditation. Finden Sie eine bequeme Position und schließen Sie die Augen.",
                                "Atmen Sie tief durch die Nase ein und langsam durch den Mund aus.",
                                "Spüren Sie, wie die Spannung von Ihren Schultern und Ihrem Nacken abfällt.",
                                "Stellen Sie sich vor, wie Sie auf einer friedlichen Wolke schweben, gewichtslos und frei.",
                                "Mit jedem Atemzug sinken Sie tiefer in einen Zustand völliger Entspannung.",
                                "Ihr Geist wird ruhig, wie ein stiller See, der den friedlichen Himmel spiegelt.",
                                "Jeder Muskel in Ihrem Körper ist jetzt vollständig entspannt.",
                                "Sie sind sicher, Sie sind friedlich, Sie sind völlig entspannt.",
                                "Genießen Sie diesen Moment tiefer Ruhe.",
                                "Wenn Sie bereit sind, bringen Sie Ihr Bewusstsein langsam zurück in den gegenwärtigen Moment."
                            ]
                        },
                        sleep: {
                            name: "Schlafreise",
                            duration: 1200,
                            frequency: "2-4 Hz (Delta)",
                            script: [
                                "Willkommen zu Ihrer Schlafreisemeditation. Legen Sie sich bequem hin und bereiten Sie sich auf die Ruhe vor.",
                                "Lassen Sie Ihre Augen schwer werden, während Sie meiner Stimme lauschen.",
                                "Stellen Sie sich vor, wie Sie in ein weiches, bequemes Bett sinken.",
                                "Jeder Atemzug führt Sie tiefer in die Entspannung.",
                                "Ihre Gedanken werden wie sanfte Wolken, die vorbeiziehen ohne Anhaftung.",
                                "Sie treten in einen Zustand tiefer, friedlicher Ruhe ein.",
                                "Der Schlaf kommt jetzt natürlich und leicht zu Ihnen.",
                                "Driften Sie friedlich in süße Träume."
                            ]
                        },
                        focus: {
                            name: "Mentale Konzentration",
                            duration: 720,
                            frequency: "8-12 Hz (Alpha)",
                            script: [
                                "Willkommen zu Ihrer mentalen Konzentrationsmeditation. Setzen Sie sich mit geradem Rücken bequem hin.",
                                "Richten Sie Ihre Aufmerksamkeit auf Ihren Atem und bemerken Sie jeden Ein- und Ausatmen.",
                                "Wenn Gedanken auftauchen, erkennen Sie sie sanft an und kehren Sie zu Ihrem Atem zurück.",
                                "Stellen Sie sich Ihren Geist als einen klaren, ruhigen See vor.",
                                "Ihre Konzentration wird mit jedem Moment des Bewusstseins schärfer.",
                                "Sie sind vollständig präsent, hier und jetzt.",
                                "Ihr Geist ist klar, fokussiert und wachsam.",
                                "Sie haben die Fähigkeit, sich tief auf das zu konzentrieren, was wichtig ist."
                            ]
                        },
                        stress: {
                            name: "Stressabbau",
                            duration: 1080,
                            frequency: "5-8 Hz (Theta)",
                            script: [
                                "Willkommen zu Ihrer Stressabbau-Meditation. Nehmen Sie sich einen Moment Zeit, um sich bequem zu machen.",
                                "Anerkennen Sie jeglichen Stress oder Spannungen, die Sie fühlen, ohne zu urteilen.",
                                "Atmen Sie tief ein und stellen Sie sich beim Ausatmen vor, diesen Stress freizugeben.",
                                "Visualisieren Sie, wie der Stress Ihren Körper wie dunkler Rauch verlässt.",
                                "Mit jedem Atemzug fühlen Sie sich leichter und friedlicher.",
                                "Ihre Schultern entspannen sich, Ihr Kiefer lockert sich, Ihre Stirn glättet sich.",
                                "Sie lassen Sorgen los und umarmen die Ruhe.",
                                "Sie sind sicher, Sie sind ruhig, Sie sind in Frieden."
                            ]
                        }
                    },
                    nl: {
                        relaxation: {
                            name: "Diepe Ontspanning",
                            duration: 900,
                            frequency: "4-7 Hz (Theta)",
                            script: [
                                "Welkom bij uw diepe ontspanningsmeditatie. Neem een comfortabele houding aan en sluit uw ogen.",
                                "Adem diep in door uw neus en adem langzaam uit door uw mond.",
                                "Voel hoe de spanning van uw schouders en nek smelt.",
                                "Stel u voor dat u op een vredige wolk zweeft, gewichtloos en vrij.",
                                "Met elke ademhaling zinkt u dieper in een staat van volledige ontspanning.",
                                "Uw geest wordt kalm, als een stille meer die de vredige hemel weerspiegelt.",
                                "Elke spier in uw lichaam is nu volledig ontspannen.",
                                "U bent veilig, u bent vredig, u bent volledig op uw gemak.",
                                "Geniet van dit moment van diepe rust.",
                                "Wanneer u klaar bent, breng uw bewustzijn langzaam terug naar het huidige moment."
                            ]
                        },
                        sleep: {
                            name: "Slaapreis",
                            duration: 1200,
                            frequency: "2-4 Hz (Delta)",
                            script: [
                                "Welkom bij uw slaapreismeditatie. Ga comfortabel liggen en bereid u voor op rust.",
                                "Laat uw ogen zwaar worden terwijl u naar mijn stem luistert.",
                                "Stel u voor hoe u in een zacht, comfortabel bed zakt.",
                                "Elke ademhaling brengt u dieper in ontspanning.",
                                "Uw gedachten worden als zachte wolken die voorbijdrijven zonder gehechtheid.",
                                "U betreedt een staat van diepe, vredige rust.",
                                "Slaap komt nu natuurlijk en gemakkelijk naar u toe.",
                                "Drijf vredig weg in zoete dromen."
                            ]
                        },
                        focus: {
                            name: "Mentale Focus",
                            duration: 720,
                            frequency: "8-12 Hz (Alpha)",
                            script: [
                                "Welkom bij uw mentale focusmeditatie. Ga comfortabel zitten met een rechte rug.",
                                "Breng uw aandag naar uw ademhaling en merk elke in- en uitademing op.",
                                "Wanneer gedachten opkomen, erken ze zachtjes en keer terug naar uw ademhaling.",
                                "Stel u uw geest voor als een heldere, kalme meer.",
                                "Uw focus wordt scherper met elk moment van bewustzijn.",
                                "U bent volledig aanwezig, hier en nu.",
                                "Uw geest is helder, gefocust en alert.",
                                "U heeft het vermogen om diep te concentreren op wat ertoe doet."
                            ]
                        },
                        stress: {
                            name: "Stressverlichting",
                            duration: 1080,
                            frequency: "5-8 Hz (Theta)",
                            script: [
                                "Welkom bij uw stressverlichtingsmeditatie. Neem een moment om u comfortabel te vestigen.",
                                "Erken eventuele stress of spanning die u voelt zonder oordeel.",
                                "Adem diep in en stel u bij het uitademen voor dat u die stress loslaat.",
                                "Visualiseer hoe de stress uw lichaam verlaat als donkere rook.",
                                "Met elke ademhaling voelt u zich lichter en vrediger.",
                                "Uw schouders ontspannen, uw kaak ontspant, uw voorhoofd wordt glad.",
                                "U laat zorgen los en omarmt de kalmte.",
                                "U bent veilig, u bent kalm, u bent in vrede."
                            ]
                        }
                    },
                    af: {
                        relaxation: {
                            name: "Diepe Ontspanning",
                            duration: 900,
                            frequency: "4-7 Hz (Theta)",
                            script: [
                                "Welkom by u diepe ontspanningsmeditasie. Vind 'n gemaklike posisie en sluit u oë.",
                                "Asem diep in deur u neus en asem stadig uit deur u mond.",
                                "Voel hoe die spanning van u skouers en nek smelt.",
                                "Stel u voor dat u op 'n vredige wolk dryf, gewigloos en vry.",
                                "Met elke asemhaal sink u dieper in 'n toestand van volledige ontspanning.",
                                "U gees word kalm, soos 'n stil meer wat die vredige hemel weerspieël.",
                                "Elke spier in u liggaam is nou volledig ontspanne.",
                                "U is veilig, u is vredig, u is heeltemal op u gemak.",
                                "Geniet hierdie oomblik van diepe rustigheid.",
                                "Wanneer u gereed is, bring u bewussyn stadig terug na die huidige oomblik."
                            ]
                        },
                        sleep: {
                            name: "Slaapreis",
                            duration: 1200,
                            frequency: "2-4 Hz (Delta)",
                            script: [
                                "Welkom by u slaapreismeditasie. Lê gemaklik neer en berei u voor vir rus.",
                                "Laat u oë swaar word terwyl u na my stem luister.",
                                "Stel u voor hoe u in 'n sagte, gemaklike bed sink.",
                                "Elke asemhaal bring u dieper in ontspanning.",
                                "U gedagtes word sagte wolke wat verbydryf sonder gehegtheid.",
                                "U betree 'n toestand van diepe, vredige rus.",
                                "Slaap kom nou natuurlik en maklik na u toe.",
                                "Dryf vredig weg in soet drome."
                            ]
                        },
                        focus: {
                            name: "Mentale Fokus",
                            duration: 720,
                            frequency: "8-12 Hz (Alpha)",
                            script: [
                                "Welkom by u mentale fokusmeditasie. Sit gemaklik met 'n reguit rug.",
                                "Bring u aandag na u asemhaling en merk elke in- en uitaseming op.",
                                "Wanneer gedagtes opduik, erken hulle sag en keer terug na u asemhaling.",
                                "Stel u u gees voor as 'n heldere, kalme meer.",
                                "U fokus word skerper met elke oomblik van bewussyn.",
                                "U is volledig teenwoordig, hier en nou.",
                                "U gees is helder, gefokus en waaksaam.",
                                "U het die vermoë om diep te fokus op wat saak maak."
                            ]
                        },
                        stress: {
                            name: "Stressverligting",
                            duration: 1080,
                            frequency: "5-8 Hz (Theta)",
                            script: [
                                "Welkom by u stressverligtingsmeditasie. Neem 'n oomblik om u gemaklik te vestigen.",
                                "Erken enige stres of spanning wat u voel sonder oordeel.",
                                "Asem diep in en stel u by die uitaseming voor dat u daardie stres loslaat.",
                                "Visualiseer hoe die stres u liggaam verlaat as donkere rook.",
                                "Met elke asemhaal voel u ligter en vrediger.",
                                "U skouers ontspan, u kaak ontspan, u voorkop word glad.",
                                "U laat sorge los en omhels die kalmte.",
                                "U is veilig, u is kalm, u is in vrede."
                            ]
                        }
                    },
                    pl: {
                        relaxation: {
                            name: "Głęboka Relaksacja",
                            duration: 900,
                            frequency: "4-7 Hz (Theta)",
                            script: [
                                "Witamy w medytacji głębokiej relaksacji. Znajdź wygodną pozycję i zamknij oczy.",
                                "Weź głęboki wdech nosem i powoli wydychaj ustami.",
                                "Poczuj, jak napięcie topnieje z Twoich ramion i karku.",
                                "Wyobraź sobie, że unosisz się na spokojnej chmurze, bezwładny i wolny.",
                                "Z każdym oddechem zatapiasz się głębiej w stan całkowitej relaksacji.",
                                "Twój umysł staje się spokojny, jak spokojne jezioro odbijające spokojne niebo.",
                                "Każdy mięsień w Twoim ciele jest teraz całkowicie zrelaksowany.",
                                "Jesteś bezpieczny, jesteś spokojny, jesteś całkowicie wyciszony.",
                                "Ciesz się tym momentem głębokiej ciszy.",
                                "Gdy będziesz gotów, powoli przywróć swoją świadomość do teraźniejszości."
                            ]
                        },
                        sleep: {
                            name: "Podróż do Snu",
                            duration: 1200,
                            frequency: "2-4 Hz (Delta)",
                            script: [
                                "Witamy w medytacji podróży do snu. Połóż się wygodnie i przygotuj się na odpoczynek.",
                                "Pozwól swoim oczom stać się ciężkimi, gdy słuchasz mojego głosu.",
                                "Wyobraź sobie, jak toniesz w miękkim, wygodnym łóżku.",
                                "Każdy oddech prowadzi Cię głębiej w relaksację.",
                                "Twoje myśli stają się jak delikatne chmury, przepływające bez przywiązania.",
                                "Wchodzisz w stan głębokiego, spokojnego odpoczynku.",
                                "Sen przychodzi teraz naturalnie i łatwo.",
                                "Spokojnie driftuj w słodkie sny."
                            ]
                        },
                        focus: {
                            name: "Skupienie Umysłu",
                            duration: 720,
                            frequency: "8-12 Hz (Alpha)",
                            script: [
                                "Witamy w medytacji skupienia umysłu. Usiądź wygodnie z wyprostowanymi plecami.",
                                "Skieruj uwagę na swój oddech, zauważając każdy wdech i wydech.",
                                "Gdy pojawią się myśli, łagodnie je zauważ i wróć do oddechu.",
                                "Wyobraź sobie swój umysł jako czyste, spokojne jezioro.",
                                "Twoje skupienie staje się ostrzejsze z każdym momentem uważności.",
                                "Jesteś całkowicie obecny, tutaj i teraz.",
                                "Twój umysł jest czysty, skupiony i czujny.",
                                "Masz zdolność do głębokiego skupienia na tym, co ważne."
                            ]
                        },
                        stress: {
                            name: "Redukcja Stresu",
                            duration: 1080,
                            frequency: "5-8 Hz (Theta)",
                            script: [
                                "Witamy w medytacji redukcji stresu. Weź chwilę, aby się wygodnie ustawić.",
                                "Uznaj wszelki stres lub napięcie, które czujesz, bez osądu.",
                                "Weź głęboki wdech i podczas wydechu wyobraź sobie uwalnianie tego stresu.",
                                "Wizualizuj, jak stres opuszcza Twoje ciało jak ciemny dym.",
                                "Z każdym oddechem czujesz się lżejszy i spokojniejszy.",
                                "Twoje ramiona rozluźniają się, Twoja szczęka rozluźnia się, Twoje czoło wygładza się.",
                                "Pozwalasz zmartwieniom odejść i obejmujesz spokój.",
                                "Jesteś bezpieczny, jesteś spokojny, jesteś w pokoju."
                            ]
                        }
                    }
                };
                
                this.natureSounds = {
                    rain: { name: "Gentle Rain", description: "Soft rainfall creating peaceful atmosphere" },
                    ocean: { name: "Ocean Waves", description: "Calming waves washing ashore" },
                    forest: { name: "Forest Ambience", description: "Peaceful forest sounds with gentle breeze" },
                    birds: { name: "Morning Birds", description: "Gentle bird songs in nature" }
                };
                
                this.languageNames = {
                    en: "English",
                    de: "Deutsch",
                    nl: "Nederlands",
                    af: "Afrikaans",
                    pl: "Polski"
                };
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.updateVolumeDisplays();
                this.updateLanguageDisplay();
                this.setupVisualizer();
                this.populateVoiceOptions();

                // Set default selections
                this.selectNatureSound('rain');
                this.selectMeditation('relaxation');
            }
            
            setupEventListeners() {
                // Language selection
                document.querySelectorAll('.language-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const lang = e.currentTarget.dataset.lang;
                        this.selectLanguage(lang);
                    });
                });
                
                // Meditation type selection
                document.querySelectorAll('.meditation-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const type = e.currentTarget.dataset.type;
                        this.selectMeditation(type);
                    });
                });
                
                // Nature sound selection
                document.querySelectorAll('.nature-sound-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const sound = e.currentTarget.dataset.sound;
                        this.selectNatureSound(sound);
                    });
                });
                
                // Volume controls
                document.getElementById('voiceVolume').addEventListener('input', (e) => {
                    this.voiceVolume = e.target.value / 100;
                    document.getElementById('voiceVolumeValue').textContent = e.target.value + '%';
                    if (this.voiceGain && this.audioContext) {
                        const now = this.audioContext.currentTime;
                        this.voiceGain.gain.cancelScheduledValues(now);
                        this.voiceGain.gain.setTargetAtTime(this.voiceVolume, now, 0.08);
                    }
                });

                document.getElementById('natureVolume').addEventListener('input', (e) => {
                    this.natureVolume = e.target.value / 100;
                    document.getElementById('natureVolumeValue').textContent = e.target.value + '%';
                    if (this.natureGainNode && this.audioContext) {
                        const now = this.audioContext.currentTime;
                        this.natureGainNode.gain.cancelScheduledValues(now);
                        this.natureGainNode.gain.setTargetAtTime(this.natureVolume, now, 0.1);
                    }
                });

                document.getElementById('binauralVolume').addEventListener('input', (e) => {
                    this.binauralVolume = e.target.value / 100;
                    document.getElementById('binauralVolumeValue').textContent = e.target.value + '%';
                    if (this.binauralGainNodes.length && this.audioContext) {
                        const now = this.audioContext.currentTime;
                        this.binauralGainNodes.forEach(gainNode => {
                            gainNode.gain.cancelScheduledValues(now);
                            gainNode.gain.setTargetAtTime(this.binauralVolume * 0.8, now, 0.1);
                        });
                    }
                });

                const voiceSelect = document.getElementById('voiceStyleSelect');
                if (voiceSelect) {
                    voiceSelect.addEventListener('change', (e) => {
                        this.selectedVoice = e.target.value;
                        this.updateVoiceDescription();

                        if (this.isPlaying && this.voiceScript.length) {
                            if (this.useBrowserSpeechFallback) {
                                this.scheduleSpeechSynthesisFrom(this.currentCuecardIndex);
                            } else {
                                this.startGuidedVoice(this.voiceScript, this.currentCuecardIndex);
                            }
                        }
                    });
                }
                
                // Control buttons
                document.getElementById('startBtn').addEventListener('click', () => this.startMeditation());
                document.getElementById('pauseBtn').addEventListener('click', () => this.pauseMeditation());
                document.getElementById('stopBtn').addEventListener('click', () => this.stopMeditation());
                
                // Play/Pause button
                document.getElementById('playPauseBtn').addEventListener('click', () => {
                    if (this.isPlaying) {
                        this.pauseMeditation();
                    } else if (this.isPaused) {
                        this.resumeMeditation();
                    } else {
                        this.startMeditation();
                    }
                });
                
                // Cuecard navigation
                document.getElementById('prevCuecardBtn').addEventListener('click', () => this.previousCuecard());
                document.getElementById('nextCuecardBtn').addEventListener('click', () => this.nextCuecard());
            }
            
            setupVisualizer() {
                const canvas = document.getElementById('visualizer');
                const ctx = canvas.getContext('2d');

                // Set canvas size
                canvas.width = window.innerWidth;
                canvas.height = 100;
                
                // Create visualizer bars
                const barCount = 50;
                const barWidth = canvas.width / barCount;
                
                for (let i = 0; i < barCount; i++) {
                    const bar = document.createElement('div');
                    bar.className = 'visualizer-bar';
                    bar.style.left = `${i * barWidth}px`;
                    bar.style.width = `${barWidth - 2}px`;
                    bar.style.height = '0px';
                    canvas.parentElement.appendChild(bar);
                    this.visualizerBars.push(bar);
                }
                
                // Handle window resize
                window.addEventListener('resize', () => {
                    canvas.width = window.innerWidth;
                    this.visualizerBars.forEach((bar, i) => {
                        bar.style.left = `${i * (canvas.width / barCount)}px`;
                        bar.style.width = `${(canvas.width / barCount) - 2}px`;
                    });
                });
            }

            populateVoiceOptions() {
                const select = document.getElementById('voiceStyleSelect');
                if (!select) return;

                const voices = this.voiceProfiles[this.currentLanguage] || [];
                select.innerHTML = '';

                voices.forEach(voice => {
                    const option = document.createElement('option');
                    option.value = voice.id;
                    option.textContent = voice.label;
                    select.appendChild(option);
                });

                if (!voices.find(voice => voice.id === this.selectedVoice)) {
                    this.selectedVoice = voices.length ? voices[0].id : '';
                }

                if (this.selectedVoice) {
                    select.value = this.selectedVoice;
                }

                this.updateVoiceDescription();
            }

            updateVoiceDescription() {
                const descriptionElement = document.getElementById('voiceStyleDescription');
                if (!descriptionElement) return;

                const voices = this.voiceProfiles[this.currentLanguage] || [];
                const selected = voices.find(voice => voice.id === this.selectedVoice);
                descriptionElement.textContent = selected ? selected.description : '';
            }
            
            animateVisualizer() {
                if (!this.analyser || !this.dataArray) return;
                
                this.analyser.getByteFrequencyData(this.dataArray);
                
                const barCount = this.visualizerBars.length;
                const step = Math.floor(this.dataArray.length / barCount);
                
                for (let i = 0; i < barCount; i++) {
                    const value = this.dataArray[i * step];
                    const height = (value / 255) * 80; // Max height 80px
                    this.visualizerBars[i].style.height = `${height}px`;
                }
                
                if (this.isPlaying) {
                    requestAnimationFrame(() => this.animateVisualizer());
                }
            }
            
            selectLanguage(lang) {
                this.currentLanguage = lang;

                // Update UI
                document.querySelectorAll('.language-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-lang="${lang}"]`).classList.add('active');

                this.updateLanguageDisplay();
                const voices = this.voiceProfiles[this.currentLanguage] || [];
                if (voices.length) {
                    this.selectedVoice = voices[0].id;
                }
                this.populateVoiceOptions();

                // Update current meditation with new language
                if (this.currentMeditation) {
                    this.selectMeditation(this.currentMeditation);
                }
            }
            
            updateLanguageDisplay() {
                const langName = this.languageNames[this.currentLanguage];
                // Update any language-specific UI elements here
            }
            
            selectMeditation(type) {
                this.currentMeditation = type;
                const meditation = this.meditationScripts[this.currentLanguage][type];
                
                // Update UI
                document.getElementById('currentSession').textContent = meditation.name;
                document.getElementById('sessionDescription').textContent = `Duration: ${Math.floor(meditation.duration / 60)} minutes`;
                document.getElementById('frequencyInfo').textContent = meditation.frequency;
                document.getElementById('totalTime').textContent = this.formatTime(meditation.duration);
                
                // Update cuecard counter
                document.getElementById('cuecardCounter').textContent = `0 / ${meditation.script.length}`;
                
                // Highlight selected card
                document.querySelectorAll('.meditation-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-type="${type}"]`).classList.add('selected');
            }
            
            selectNatureSound(sound) {
                this.selectedNatureSound = sound;

                // Update UI
                document.querySelectorAll('.nature-sound-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                document.querySelector(`[data-sound="${sound}"]`).classList.add('selected');

                if (this.isPlaying && this.audioContext) {
                    this.startNatureSounds();
                }
            }
            
            updateVolumeDisplays() {
                document.getElementById('voiceVolumeValue').textContent = Math.round(this.voiceVolume * 100) + '%';
                document.getElementById('natureVolumeValue').textContent = Math.round(this.natureVolume * 100) + '%';
                document.getElementById('binauralVolumeValue').textContent = Math.round(this.binauralVolume * 100) + '%';
            }
            
            async startMeditation() {
                if (!this.currentMeditation) {
                    alert('Please select a meditation type first.');
                    return;
                }
                
                // Show loading overlay
                document.getElementById('loadingOverlay').classList.add('active');
                
                try {
                    // Initialize audio context
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    
                    // Resume audio context in case it was suspended
                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }
                    
                    // Setup analyzer for visualization
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    this.dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                    
                    this.isPlaying = true;
                    this.isPaused = false;
                    this.startTime = Date.now();
                    this.pausedTime = 0;
                    this.currentCuecardIndex = 0;
                    this.voiceQueue = [];
                    this.voiceScript = [];
                    this.currentVoiceSource = null;
                    this.natureSoundSource = null;
                    this.natureGainNode = null;
                    this.binauralGainNodes = [];
                    this.binauralOscillators = [];
                    this.updateControlButtons();
                    this.updatePlayPauseButton();
                    this.showBreathingAnimation();

                    const meditation = this.meditationScripts[this.currentLanguage][this.currentMeditation];
                    
                    // Create master gain node
                    this.masterGain = this.audioContext.createGain();
                    this.masterGain.gain.setValueAtTime(1.0, this.audioContext.currentTime);
                    this.masterGain.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);

                    this.voiceGain = this.audioContext.createGain();
                    this.voiceGain.gain.setValueAtTime(this.voiceVolume, this.audioContext.currentTime);
                    this.voiceGain.connect(this.masterGain);

                    // Setup voice ambience effect
                    this.voiceDelayNode = this.audioContext.createDelay(0.5);
                    this.voiceDelayNode.delayTime.setValueAtTime(0.35, this.audioContext.currentTime);
                    this.voiceEchoGain = this.audioContext.createGain();
                    this.voiceEchoGain.gain.setValueAtTime(0.18, this.audioContext.currentTime);
                    this.voiceGain.connect(this.voiceDelayNode);
                    this.voiceDelayNode.connect(this.voiceEchoGain);
                    this.voiceEchoGain.connect(this.masterGain);

                    // Start audio components
                    await this.startBinauralBeats(meditation.frequency);
                    await this.startNatureSounds();
                    await this.startGuidedVoice(meditation.script, 0);
                    
                    // Start progress tracking
                    this.startProgressTracking();
                    
                    // Start visualizer animation
                    this.animateVisualizer();
                    
                    // Hide loading overlay after a delay to show initialization is complete
                    setTimeout(() => {
                        document.getElementById('loadingOverlay').classList.remove('active');
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error starting meditation:', error);
                    document.getElementById('loadingOverlay').classList.remove('active');
                    alert('Error starting meditation. Please check your browser permissions.');
                }
            }
            
            pauseMeditation() {
                if (!this.isPlaying) return;
                
                this.isPlaying = false;
                this.isPaused = true;
                this.pausedTime = Date.now() - this.startTime;
                this.updateControlButtons();
                this.updatePlayPauseButton();
                this.hideBreathingAnimation();
                
                if (this.audioContext) {
                    this.audioContext.suspend();
                }

                // Pause speech synthesis
                if (this.useBrowserSpeechFallback && 'speechSynthesis' in window) {
                    speechSynthesis.pause();
                }
            }

            resumeMeditation() {
                if (!this.isPaused) return;
                
                this.isPlaying = true;
                this.isPaused = false;
                this.startTime = Date.now() - this.pausedTime;
                this.updateControlButtons();
                this.updatePlayPauseButton();
                this.showBreathingAnimation();
                
                if (this.audioContext) {
                    this.audioContext.resume();
                }

                // Resume speech synthesis
                if (this.useBrowserSpeechFallback && 'speechSynthesis' in window) {
                    speechSynthesis.resume();
                }

                // Restart progress tracking
                this.startProgressTracking();
                
                // Restart visualizer animation
                this.animateVisualizer();
            }
            
            stopMeditation() {
                this.isPlaying = false;
                this.isPaused = false;
                this.updateControlButtons();
                this.updatePlayPauseButton();
                this.hideBreathingAnimation();
                this.resetCuecard();

                this.stopVoicePlayback();

                if (this.audioContext) {
                    if (this.natureSoundSource && this.natureGainNode) {
                        this.fadeOutAndStop(this.natureSoundSource, this.natureGainNode);
                    }
                    this.natureSoundSource = null;
                    this.natureGainNode = null;

                    if (this.binauralOscillators.length) {
                        this.binauralOscillators.forEach(osc => {
                            try {
                                osc.stop();
                            } catch (error) {
                                // ignore
                            }
                            try {
                                osc.disconnect();
                            } catch (error) {
                                // ignore
                            }
                        });
                        this.binauralOscillators = [];
                    }
                    this.binauralGainNodes = [];
                }

                if (this.audioContext) {
                    this.audioContext.close();
                    this.audioContext = null;
                }

                this.voiceGain = null;
                this.voiceDelayNode = null;
                this.voiceEchoGain = null;
                this.voiceQueue = [];
                this.voiceScript = [];
                this.currentVoiceSource = null;
                this.useBrowserSpeechFallback = false;
                this.activeVoiceRequestId = 0;

                // Reset visualizer
                this.visualizerBars.forEach(bar => {
                    bar.style.height = '0px';
                });
                
                // Reset progress
                document.getElementById('progressBar').style.width = '0%';
                document.getElementById('currentTime').textContent = '0:00';
            }
            
            updateControlButtons() {
                const startBtn = document.getElementById('startBtn');
                const pauseBtn = document.getElementById('pauseBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                if (this.isPlaying) {
                    startBtn.disabled = true;
                    pauseBtn.disabled = false;
                    stopBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    pauseBtn.disabled = true;
                    stopBtn.disabled = false;
                }
            }
            
            updatePlayPauseButton() {
                const icon = document.getElementById('playPauseIcon');
                
                if (this.isPlaying) {
                    icon.className = 'fas fa-pause text-3xl text-white';
                } else {
                    icon.className = 'fas fa-play text-3xl text-white';
                }
            }
            
            showBreathingAnimation() {
                const circle = document.getElementById('breathingCircle');
                const text = document.getElementById('breathingText');
                circle.classList.remove('hidden');
                text.textContent = 'Breathe in... and out...';
            }
            
            hideBreathingAnimation() {
                const circle = document.getElementById('breathingCircle');
                const text = document.getElementById('breathingText');
                circle.classList.add('hidden');
                text.textContent = 'Breathe naturally';
            }
            
            updateCuecard(text) {
                const cuecardText = document.getElementById('cuecardText');
                cuecardText.textContent = text;
                
                // Update cuecard counter
                const meditation = this.meditationScripts[this.currentLanguage][this.currentMeditation];
                document.getElementById('cuecardCounter').textContent = 
                    `${this.currentCuecardIndex + 1} / ${meditation.script.length}`;
                
                // Update navigation buttons
                document.getElementById('prevCuecardBtn').disabled = this.currentCuecardIndex === 0;
                document.getElementById('nextCuecardBtn').disabled = 
                    this.currentCuecardIndex >= meditation.script.length - 1;
            }
            
            previousCuecard() {
                if (this.currentCuecardIndex <= 0) return;

                const targetIndex = this.currentCuecardIndex - 1;

                if (this.useBrowserSpeechFallback) {
                    this.scheduleSpeechSynthesisFrom(targetIndex);
                } else if (this.voiceQueue.length) {
                    this.playVoiceBufferAtIndex(targetIndex);
                }
            }

            nextCuecard() {
                const meditation = this.meditationScripts[this.currentLanguage][this.currentMeditation];
                if (!meditation) return;

                const targetIndex = Math.min(this.currentCuecardIndex + 1, meditation.script.length - 1);

                if (targetIndex === this.currentCuecardIndex) return;

                if (this.useBrowserSpeechFallback) {
                    this.scheduleSpeechSynthesisFrom(targetIndex);
                } else if (this.voiceQueue.length) {
                    this.playVoiceBufferAtIndex(targetIndex);
                }
            }
            
            resetCuecard() {
                const cuecardText = document.getElementById('cuecardText');
                cuecardText.textContent = 'Meditation guidance will appear here';
                
                // Reset cuecard counter
                const meditation = this.meditationScripts[this.currentLanguage][this.currentMeditation];
                if (meditation) {
                    document.getElementById('cuecardCounter').textContent = `0 / ${meditation.script.length}`;
                }
                
                // Reset navigation buttons
                document.getElementById('prevCuecardBtn').disabled = true;
                document.getElementById('nextCuecardBtn').disabled = true;
            }
            
            startProgressTracking() {
                const meditation = this.meditationScripts[this.currentLanguage][this.currentMeditation];
                const duration = meditation.duration * 1000;
                
                const updateProgress = () => {
                    if (!this.isPlaying) return;
                    
                    const elapsed = Date.now() - this.startTime;
                    const progress = Math.min((elapsed / duration) * 100, 100);
                    
                    document.getElementById('progressBar').style.width = progress + '%';
                    document.getElementById('currentTime').textContent = this.formatTime(elapsed / 1000);
                    
                    if (progress < 100) {
                        requestAnimationFrame(updateProgress);
                    } else {
                        this.stopMeditation();
                    }
                };
                
                updateProgress();
            }
            
            formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            async startBinauralBeats(frequency) {
                if (!this.audioContext) return;

                const freqMatch = frequency.match(/(\d+)-(\d+)/);
                if (!freqMatch) return;

                if (this.binauralOscillators.length) {
                    this.binauralOscillators.forEach(osc => {
                        try {
                            osc.stop();
                        } catch (err) {
                            // ignore
                        }
                        osc.disconnect();
                    });
                    this.binauralOscillators = [];
                }

                const leftFreq = parseFloat(freqMatch[1]);
                const rightFreq = parseFloat(freqMatch[2]);

                const leftOscillator = this.audioContext.createOscillator();
                const rightOscillator = this.audioContext.createOscillator();
                
                const leftGain = this.audioContext.createGain();
                const rightGain = this.audioContext.createGain();
                
                const merger = this.audioContext.createChannelMerger(2);
                
                // Create echo effect
                const delay = this.audioContext.createDelay(0.3);
                const delayGain = this.audioContext.createGain();
                delayGain.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                
                leftOscillator.frequency.setValueAtTime(leftFreq, this.audioContext.currentTime);
                rightOscillator.frequency.setValueAtTime(rightFreq, this.audioContext.currentTime);
                
                // Increased volume for binaural beats to make them audible
                leftGain.gain.setValueAtTime(this.binauralVolume * 0.8, this.audioContext.currentTime);
                rightGain.gain.setValueAtTime(this.binauralVolume * 0.8, this.audioContext.currentTime);
                
                // Connect nodes with echo
                leftOscillator.connect(leftGain);
                rightOscillator.connect(rightGain);
                
                // Direct connection
                leftGain.connect(merger, 0, 0);
                rightGain.connect(merger, 0, 1);
                
                // Echo connection
                leftGain.connect(delay);
                rightGain.connect(delay);
                delay.connect(delayGain);
                delayGain.connect(merger, 0, 0);
                delayGain.connect(merger, 0, 1);

                merger.connect(this.masterGain);

                leftOscillator.start();
                rightOscillator.start();

                this.binauralOscillators = [leftOscillator, rightOscillator];
                this.binauralGainNodes = [leftGain, rightGain];
            }

            async startNatureSounds() {
                if (!this.audioContext) return;

                const previousSource = this.natureSoundSource;
                const previousGain = this.natureGainNode;

                if (previousSource && previousGain) {
                    this.fadeOutAndStop(previousSource, previousGain);
                }

                const gainNode = this.audioContext.createGain();
                gainNode.gain.setValueAtTime(this.natureVolume, this.audioContext.currentTime);

                let buffer = null;
                try {
                    buffer = await this.ensureNatureBuffer(this.selectedNatureSound);
                } catch (error) {
                    console.warn('Falling back to generated nature ambience:', error);
                }

                if (!buffer) {
                    buffer = this.generateAmbientNature(this.selectedNatureSound);
                }

                if (!buffer) return;

                const source = this.audioContext.createBufferSource();
                source.buffer = buffer;
                source.loop = true;
                source.connect(gainNode);
                gainNode.connect(this.masterGain);

                source.start();

                this.natureSoundSource = source;
                this.natureGainNode = gainNode;
            }

            async startGuidedVoice(script, startIndex = 0) {
                if (!this.audioContext) return;

                const safeIndex = Math.max(0, Math.min(startIndex, script.length ? script.length - 1 : 0));

                this.voiceScript = Array.isArray(script) ? [...script] : [];
                this.stopVoicePlayback();

                if (!this.voiceScript.length) return;

                const requestId = Date.now();
                this.activeVoiceRequestId = requestId;

                try {
                    const buffers = await this.prepareVoiceBuffers(this.voiceScript);
                    if (this.activeVoiceRequestId !== requestId) {
                        return;
                    }
                    this.voiceQueue = buffers;
                    this.useBrowserSpeechFallback = false;
                    this.playVoiceBufferAtIndex(safeIndex);
                } catch (error) {
                    if (this.activeVoiceRequestId !== requestId) {
                        return;
                    }
                    console.warn('Guided voice API unavailable, using browser speech synthesis.', error);
                    this.useBrowserSpeechFallback = true;
                    this.voiceQueue = [];
                    this.scheduleSpeechSynthesisFrom(safeIndex);
                }
            }

            async prepareVoiceBuffers(script) {
                const voices = this.voiceProfiles[this.currentLanguage] || [];
                const voiceId = this.selectedVoice || (voices.length ? voices[0].id : null);

                if (!voiceId) {
                    throw new Error('No guided voice available for the selected language.');
                }

                const results = await Promise.allSettled(
                    script.map(text => this.fetchVoiceAudio(text, voiceId))
                );

                const failure = results.find(result => result.status !== 'fulfilled');
                if (failure) {
                    throw failure.reason || new Error('Unable to prepare guided voice audio.');
                }

                const buffers = results.map(result => result.value);
                if (!buffers.length) {
                    throw new Error('Guided voice response did not include audio.');
                }

                return buffers;
            }

            async fetchVoiceAudio(text, voiceId) {
                if (!this.audioContext) {
                    throw new Error('Audio context is not initialized.');
                }

                const cacheKey = `${voiceId}|${this.currentLanguage}|${text}`;
                let audioData = this.voiceClipCache.get(cacheKey);

                if (!audioData) {
                    const requestUrl = `https://api.streamelements.com/kappa/v2/speech?voice=${encodeURIComponent(voiceId)}&text=${encodeURIComponent(text)}`;
                    const response = await fetch(requestUrl);
                    if (!response.ok) {
                        throw new Error(`Voice request failed with status ${response.status}`);
                    }
                    const arrayBuffer = await response.arrayBuffer();
                    audioData = arrayBuffer.slice(0);
                    this.voiceClipCache.set(cacheKey, audioData);
                }

                return await this.decodeAudioData(audioData.slice(0));
            }

            decodeAudioData(arrayBuffer) {
                return new Promise((resolve, reject) => {
                    this.audioContext.decodeAudioData(arrayBuffer, resolve, reject);
                });
            }

            playVoiceBufferAtIndex(index) {
                if (!this.audioContext || !this.voiceQueue.length) return;
                if (index < 0 || index >= this.voiceQueue.length) return;

                this.stopCurrentVoiceSource();

                const source = this.audioContext.createBufferSource();
                source.buffer = this.voiceQueue[index];
                const targetNode = this.voiceGain || this.masterGain;
                source.connect(targetNode);
                source.start();

                this.currentVoiceSource = source;
                this.currentCuecardIndex = index;
                this.updateCuecard(this.voiceScript[index]);

                source.onended = () => {
                    if (!this.isPlaying || this.currentVoiceSource !== source) return;
                    const nextIndex = index + 1;
                    if (nextIndex < this.voiceQueue.length) {
                        this.playVoiceBufferAtIndex(nextIndex);
                    }
                };
            }

            stopCurrentVoiceSource() {
                if (!this.currentVoiceSource) return;

                try {
                    this.currentVoiceSource.onended = null;
                    this.currentVoiceSource.stop();
                } catch (error) {
                    // Ignore if already stopped
                }

                try {
                    this.currentVoiceSource.disconnect();
                } catch (error) {
                    // Ignore disconnect errors
                }

                this.currentVoiceSource = null;
            }

            stopVoicePlayback() {
                this.stopCurrentVoiceSource();

                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }

                this.speechTimeouts.forEach(timeoutId => clearTimeout(timeoutId));
                this.speechTimeouts = [];
            }

            scheduleSpeechSynthesisFrom(startIndex = 0) {
                if (!('speechSynthesis' in window) || !this.voiceScript.length) return;

                this.stopVoicePlayback();
                this.useBrowserSpeechFallback = true;

                const safeIndex = Math.max(0, Math.min(startIndex, this.voiceScript.length - 1));
                const baseDelay = 8000;
                const firstText = this.voiceScript[safeIndex];
                this.currentCuecardIndex = safeIndex;
                this.updateCuecard(firstText);
                this.playSpeechUtterance(firstText);

                for (let i = safeIndex + 1; i < this.voiceScript.length; i++) {
                    const text = this.voiceScript[i];
                    const delay = (i - safeIndex) * baseDelay;

                    const timeoutId = setTimeout(() => {
                        if (!this.isPlaying) return;
                        this.currentCuecardIndex = i;
                        this.updateCuecard(text);
                        this.playSpeechUtterance(text);
                    }, delay);

                    this.speechTimeouts.push(timeoutId);
                }
            }

            playSpeechUtterance(text) {
                if (!('speechSynthesis' in window)) return;

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.65;
                utterance.pitch = 0.95;
                utterance.volume = Math.min(this.voiceVolume, 1);

                const langMap = {
                    en: 'en-US',
                    de: 'de-DE',
                    nl: 'nl-NL',
                    af: 'af-ZA',
                    pl: 'pl-PL'
                };

                const langCode = langMap[this.currentLanguage] || 'en-US';
                utterance.lang = langCode;

                const voices = speechSynthesis.getVoices();
                const matchingVoice = voices.find(voice =>
                    voice.lang === langCode || voice.lang.startsWith(langCode.split('-')[0])
                );

                if (matchingVoice) {
                    utterance.voice = matchingVoice;
                }

                speechSynthesis.speak(utterance);
            }

            async ensureNatureBuffer(type) {
                if (!this.audioContext) return null;

                if (this.natureBuffers[type]) {
                    return this.natureBuffers[type];
                }

                const url = this.natureSoundMap[type];
                if (!url) {
                    const generated = this.generateAmbientNature(type);
                    this.natureBuffers[type] = generated;
                    return generated;
                }

                try {
                    const response = await fetch(url, { cache: 'force-cache' });
                    if (!response.ok) {
                        throw new Error(`Failed to load nature ambience (status ${response.status})`);
                    }

                    const arrayBuffer = await response.arrayBuffer();
                    const buffer = await this.decodeAudioData(arrayBuffer);
                    this.natureBuffers[type] = buffer;
                    return buffer;
                } catch (error) {
                    console.warn('Unable to retrieve remote nature loop:', error);
                    const generated = this.generateAmbientNature(type);
                    this.natureBuffers[type] = generated;
                    return generated;
                }
            }

            generateAmbientNature(type) {
                if (!this.audioContext) return null;

                const duration = 60; // seconds
                const sampleRate = this.audioContext.sampleRate;
                const channels = 2;
                const frameCount = duration * sampleRate;
                const buffer = this.audioContext.createBuffer(channels, frameCount, sampleRate);

                for (let channel = 0; channel < channels; channel++) {
                    const data = buffer.getChannelData(channel);
                    let brown = 0;
                    const drift = channel === 0 ? 0.0003 : -0.0003;

                    for (let i = 0; i < frameCount; i++) {
                        const white = Math.random() * 2 - 1;
                        brown = (brown + 0.02 * white) / 1.02;
                        let value = 0;

                        switch (type) {
                            case 'ocean': {
                                const t = i / sampleRate;
                                const slowSwell = Math.sin(2 * Math.PI * 0.08 * t + drift * i) * 0.5;
                                const deepWave = Math.sin(2 * Math.PI * 0.18 * t + channel * 0.4) * 0.3;
                                value = slowSwell + deepWave + brown * 0.4 + (Math.random() * 2 - 1) * 0.05;
                                break;
                            }
                            case 'forest': {
                                value = brown * 0.35 + (Math.random() * 2 - 1) * 0.05;
                                break;
                            }
                            case 'birds': {
                                value = brown * 0.2;
                                break;
                            }
                            default: {
                                value = brown * 0.45 + (Math.random() * 2 - 1) * 0.05;
                                break;
                            }
                        }

                        data[i] = value;
                    }

                    if (type === 'rain') {
                        const dropCount = Math.floor(duration * 14);
                        const dropLength = Math.floor(sampleRate * 0.12);
                        for (let d = 0; d < dropCount; d++) {
                            const start = Math.floor(Math.random() * Math.max(1, frameCount - dropLength - 1));
                            for (let j = 0; j < dropLength; j++) {
                                const envelope = Math.sin((j / dropLength) * Math.PI);
                                data[start + j] += envelope * 0.35;
                            }
                        }
                    } else if (type === 'forest' || type === 'birds') {
                        const chirpCount = Math.floor(duration * (type === 'birds' ? 18 : 8));
                        for (let c = 0; c < chirpCount; c++) {
                            const start = Math.floor(Math.random() * Math.max(1, frameCount - sampleRate * 0.25 - 1));
                            const chirpLength = Math.floor(sampleRate * (0.12 + Math.random() * 0.12));
                            const frequency = 1200 + Math.random() * 1600;
                            for (let j = 0; j < chirpLength && start + j < frameCount; j++) {
                                const envelope = Math.sin((j / chirpLength) * Math.PI) ** 2;
                                const angle = 2 * Math.PI * frequency * (j / sampleRate);
                                const intensity = type === 'birds' ? 0.45 : 0.25;
                                data[start + j] += Math.sin(angle) * envelope * intensity;
                            }
                        }
                    }
                }

                for (let channel = 0; channel < channels; channel++) {
                    const data = buffer.getChannelData(channel);
                    let previous = 0;
                    for (let i = 0; i < frameCount; i++) {
                        previous = previous * 0.995 + data[i] * 0.005;
                        data[i] = previous;
                    }
                    for (let i = 0; i < frameCount; i++) {
                        data[i] = Math.max(-0.9, Math.min(0.9, data[i]));
                    }
                }

                return buffer;
            }

            fadeOutAndStop(source, gainNode) {
                if (!this.audioContext || !source || !gainNode) return;

                const now = this.audioContext.currentTime;
                try {
                    gainNode.gain.cancelScheduledValues(now);
                    gainNode.gain.setTargetAtTime(0.0001, now, 0.2);
                } catch (error) {
                    // Ignore scheduling issues
                }

                setTimeout(() => {
                    try {
                        source.stop();
                    } catch (error) {
                        // Ignore if already stopped
                    }

                    try {
                        source.disconnect();
                    } catch (error) {
                        // Ignore disconnect errors
                    }

                    try {
                        gainNode.disconnect();
                    } catch (error) {
                        // Ignore disconnect errors
                    }
                }, 400);
            }
        }
        
        // Initialize the meditation generator when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new MeditationGenerator();
        });
        
        // Load voices when available
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                // Voices are loaded
            };
        }
    </script>
</body>
</html>
