<!--
 WebDoc ‚Äî A4 HTML Paged Renderer v0.1.0 (LTS)
 @version 0.1.0
 @codename "WebDoc 0.1.0 ‚Äî Flatline"
 @notes
  - Minimal, flat UI with menubar (File / Edit / Options / Export) + compact pager
  - Three screen themes: Normal / Medium (gray) / Dark (OLED-friendly)
  - Internal single-file format: **WebDoc** JSON (supports embedded SVG/IMG via data: URLs)
  - Two export modes: Bleed 216√ó303 mm, Trim-only A4 210√ó297 mm (anchored at 0,0)
  - 32 pages demo; thumbnails; pro print marks; typography preserved
-->
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Language" content="pl" />
<title>WebDoc 0.1.0 ‚Äî FanZin A4</title>
<style>
  /* ===== Base & Theme Vars ===== */
  *,*::before,*::after{ box-sizing: border-box; }
  html,body{ margin:0; padding:0; }
  :root{
    --bleed: 3mm;
    --page-w: 210mm; --page-h: 297mm;
    --sheet-w: calc(var(--page-w) + 2*var(--bleed));
    --sheet-h: calc(var(--page-h) + 2*var(--bleed));
    --m-top: 15mm; --m-out: 17mm; --m-bot: 20mm; --m-in: 17mm; /* screen layout */
    --col-gap: 6mm;
    --ui-h: 40px; --menubar-h: 36px; --sidebar-w: 188px;

    /* theme tokens (overridden by body.theme-*) */
    --bg: #ffffff; --fg:#111827; --fg-2:#4b5563; --stroke:#e5e7eb; --fill:#f3f4f6;
    --thumb-bg:#f6f7f8; --paper:#ffffff; --ink:#111; --rule:#e5e7eb; --brand:#0ea5e9;

    --font-ui: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", sans-serif;
    --font-body: "Literata", "Source Serif 4", "Noto Serif", "PT Serif", ui-serif, Georgia, serif;

    --crop-l: 7mm; --crop-w: 0.25mm;
  }
  body.theme-normal{ background:#fafafa; }
  body.theme-medium{ --bg:#f3f4f6; --fg:#111827; --fg-2:#374151; --stroke:#d1d5db; --fill:#e5e7eb; --thumb-bg:#e5e7eb; background:#e5e7eb; }
  body.theme-dark{ --bg:#0b0f14; --fg:#e5e7eb; --fg-2:#9ca3af; --stroke:#1f2937; --fill:#111827; --thumb-bg:#0f141a; --paper:#0d1117; --ink:#e5e7eb; --rule:#1f2937; --brand:#3b82f6; background:#0a0f15; color-scheme: dark; }

  /* ===== Menubar ===== */
  .menubar{ position:sticky; top:0; z-index:1100; height:var(--menubar-h); background:var(--bg); border-bottom:1px solid var(--stroke); display:flex; align-items:center; gap:8px; padding:0 10px; font:12px var(--font-ui); }
  .menu{ position:relative; }
  .menu > button{ height:28px; padding:0 10px; border:1px solid transparent; background:transparent; border-radius:6px; color:var(--fg); cursor:pointer; }
  .menu > button:hover, .menu.open > button{ background:var(--fill); border-color:var(--stroke); }
  .dropdown{ position:absolute; top:32px; left:0; min-width:220px; background:var(--bg); border:1px solid var(--stroke); border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.08); padding:6px; display:none; }
  .menu.open .dropdown{ display:block; }
  .item{ display:flex; align-items:center; justify-content:space-between; gap:8px; padding:6px 8px; border-radius:6px; cursor:pointer; color:var(--fg); }
  .item:hover{ background:var(--fill); }
  .item label{ width:100%; display:flex; align-items:center; gap:8px; cursor:pointer; }
  .item .k{ color:var(--fg-2); font-size:11px; }
  .sep{ height:1px; background:var(--stroke); margin:6px 0; }
  .right{ margin-left:auto; }

  /* ===== Pager (compact) ===== */
  .toolbar{ position:sticky; top:var(--menubar-h); z-index:1000; height:var(--ui-h); display:flex; align-items:center; gap:8px; padding:6px 10px; background:var(--bg); border-bottom:1px solid var(--stroke); }
  .btn{ height:26px; padding:0 8px; border:1px solid var(--stroke); background:#fff0; border-radius:6px; font:12px var(--font-ui); color:var(--fg); cursor:pointer; display:inline-flex; align-items:center; gap:6px; }
  .btn:hover{ background:var(--fill); }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }
  .btn-icon{ width:26px; justify-content:center; padding:0; }
  .field{ height:26px; padding:0 6px; border:1px solid var(--stroke); background:transparent; color:var(--fg); border-radius:6px; font:12px var(--font-ui); }
  .stat{ font:12px var(--font-ui); color:var(--fg-2); }
  .spacer{ flex:1 1 auto; }

  /* ===== Sidebar & Thumbs ===== */
  #sidebar{ position:fixed; top:calc(var(--menubar-h) + var(--ui-h)); left:0; bottom:0; width: var(--sidebar-w); background:var(--thumb-bg); border-right:1px solid var(--stroke); padding:8px; overflow:auto; }
  #thumbs .thumb{ padding:6px; margin-bottom:8px; background:var(--bg); border:1px solid var(--stroke); border-radius:6px; cursor:pointer; }
  #thumbs .thumb.active{ outline:2px solid var(--brand); }
  .mini-wrap{ width: 140px; height: 205px; overflow:hidden; position:relative; margin: 0 auto 6px; background:var(--bg); }
  .mini-wrap .sheet{ box-shadow:none; border:none; }
  .mini-wrap .trim::before, .mini-wrap .crop, .mini-wrap .marks{ display:none; }
  .mini-meta{ text-align:center; font: 11px var(--font-ui); color:var(--fg-2); }

  /* ===== Pages ===== */
  #pages{ margin-left: calc(var(--sidebar-w) + 10px); }
  .sheet{ position: relative; width: var(--sheet-w); height: var(--sheet-h); background: var(--paper); color: var(--ink); box-shadow: 0 10px 30px rgba(0,0,0,.06); margin: 10px auto; border:1px solid var(--stroke); border-radius:8px; scroll-margin-top: calc(var(--menubar-h) + var(--ui-h) + 8px); overflow:hidden; }
  .sheet{ --inPage: var(--m-in); --outPage: var(--m-out); }
  .sheet.even{ --inPage: var(--m-out); --outPage: var(--m-in); }

  /* Crop marks */
  .crop{ position:absolute; width:0; height:0; }
  .crop::before, .crop::after{ content:""; position:absolute; background:#000; }
  .crop.tl{ left: var(--bleed); top: var(--bleed); }
  .crop.tr{ right: var(--bleed); top: var(--bleed); }
  .crop.bl{ left: var(--bleed); bottom: var(--bleed); }
  .crop.br{ right: var(--bleed); bottom: var(--bleed); }
  .crop.tl::after, .crop.tr::after, .crop.bl::after, .crop.br::after{ height: var(--crop-w); width: var(--crop-l); }
  .crop.tl::after{ left: 0; top: calc(var(--m-top) - var(--crop-w)); transform: translateX(calc(-1 * var(--crop-l))); }
  .crop.tr::after{ right: 0; top: calc(var(--m-top) - var(--crop-w)); }
  .crop.bl::after{ left: 0; bottom: calc(var(--m-bot) - var(--crop-w)); transform: translateX(calc(-1 * var(--crop-l))); }
  .crop.br::after{ right: 0; bottom: calc(var(--m-bot) - var(--crop-w)); }
  .crop.tl::before, .crop.tr::before, .crop.bl::before, .crop.br::before{ width: var(--crop-w); height: var(--crop-l); }
  .crop.tl::before{ top: 0; left: calc(var(--inPage) - var(--crop-w)); transform: translateY(calc(-1 * var(--crop-l))); }
  .crop.tr::before{ top: 0; right: calc(var(--outPage) - var(--crop-w)); transform: translateY(calc(-1 * var(--crop-l))); }
  .crop.bl::before{ bottom: 0; left: calc(var(--inPage) - var(--crop-w)); }
  .crop.br::before{ bottom: 0; right: calc(var(--outPage) - var(--crop-w)); }

  /* Trim & Content */
  .trim{ position:absolute; left: var(--bleed); top: var(--bleed); width: var(--page-w); height: var(--page-h); }
  .trim::before{ content:""; position:absolute; left: var(--inPage); right: var(--outPage); top: var(--m-top); bottom: var(--m-bot); border:0.4pt dashed var(--rule); }
  .content{ position:absolute; left: var(--inPage); right: var(--outPage); top: var(--m-top); bottom: var(--m-bot); }

  /* Print marks */
  .marks{ position:absolute; inset:0; pointer-events:none; }
  .marks .colorbar{ position:absolute; left: var(--bleed); right: var(--bleed); bottom: 0.8mm; height: 6mm; display:flex; gap:0.6mm; align-items:stretch; }
  .marks .patch{ flex:0 0 10mm; height:100%; border:0.2pt solid #ccc; }
  .patch.c{ background:#00B5E2; } .patch.m{ background:#D5006D; } .patch.y{ background:#FFD400; } .patch.k{ background:#000; }
  .patch.r{ background:#FF3B30; } .patch.g{ background:#34C759; } .patch.b{ background:#007AFF; }
  .patch.w{ background:#fff; } .patch.g10{ background:#1a1a1a; } .patch.g20{ background:#333; } .patch.g30{ background:#4d4d4d; }
  .patch.g40{ background:#666; } .patch.g50{ background:#808080; } .patch.g60{ background:#999; } .patch.g70{ background:#b3b3b3; } .patch.g80{ background:#ccc; } .patch.g90{ background:#e6e6e6; }
  .marks .info{ position:absolute; right: var(--bleed); top: 0.8mm; font: 10px var(--font-ui); color:#000; background:#fff; padding:2px 4px; border:1px solid #d1d5db; border-radius:4px; }
  .marks .reg{ position:absolute; width:7mm; height:7mm; border-radius:50%; border:0.6pt solid #000; }
  .marks .reg::before, .marks .reg::after{ content:""; position:absolute; left:50%; top:50%; background:#000; transform:translate(-50%,-50%); }
  .marks .reg::before{ width:6mm; height:0.25mm; }
  .marks .reg::after{ width:0.25mm; height:6mm; }
  .marks .reg.tl{ left: 1mm; top: 1mm; } .marks .reg.tr{ right: 1mm; top: 1mm; }
  .marks .reg.bl{ left: 1mm; bottom: 1mm; } .marks .reg.br{ right: 1mm; bottom: 1mm; }
  .marks .safe-area{ position:absolute; left: var(--bleed); right: var(--bleed); top: var(--bleed); bottom: var(--bleed); border:0.2pt dotted #bbb; }
  body.printshop .marks::after{ content:""; position:absolute; inset:0; background:
    repeating-linear-gradient(to bottom, rgba(0,0,0,.06), rgba(0,0,0,.06) 0.4mm, transparent 0.4mm, transparent 1.6mm),
    repeating-linear-gradient(to right, rgba(0,0,0,.04), rgba(0,0,0,.04) 0.4mm, transparent 0.4mm, transparent 1.6mm);
  }
  body.printshop .marks .slur{ position:absolute; width:14mm; height:14mm; border:0.5pt dashed #000; border-radius: 50%; left: calc(50% - 7mm); top: 1mm; }

  /* Typography */
  body{ font-family: var(--font-body); font-size: 10.5pt; line-height: 1.42; font-kerning: normal; font-feature-settings: "liga" on, "kern" on; }
  h1,h2,h3{ font-family: var(--font-ui); margin:0 0 3mm 0; line-height:1.2; color:var(--fg); }
  h1.title{ font-size: 22pt; }
  h2{ font-size: 13.5pt; }
  h3{ font-size: 11pt; }
  p{ margin:0 0 3.2mm 0; hyphens:auto; orphans:3; widows:3; color: var(--fg); }
  .head{ padding: 7mm 0 3.5mm 0; border-bottom: .3pt solid var(--rule); }
  .cols{ padding: 4mm 0 0 0; column-fill:auto; }
  .cols-1{ column-count:1; }
  .cols-2{ column-count:2; column-gap: var(--col-gap); }
  .cols-3{ column-count:3; column-gap: var(--col-gap); }
  .cols p, .cols li, .cols figure, .cols h2, .cols h3{ break-inside: avoid-column; }
  .span-all{ column-span: all; break-before: column; break-after: column; }
  .split{ padding-bottom: 6mm; }
  .foot{ padding: 3.5mm 0 5mm 0; border-top: .3pt solid var(--rule); font: 9.5pt var(--font-ui); color:var(--fg-2); display:flex; justify-content:space-between; }
  figure{ margin:0 0 4mm 0; }
  .ph{ width:100%; height:40mm; background: linear-gradient(135deg,#e8f7fb,#f5e8ff); border:0.3pt solid #dcdcdc; }
  figcaption{ font: 9.5pt var(--font-ui); color:#6b7280; margin-top:1.6mm; }

  /* Toggles */
  body.hide-guides .trim::before{ display:none !important; }
  body.hide-crops .crop{ display:none !important; }
  body.hide-colorbar .marks .colorbar{ display:none !important; }
  body.hide-reg .marks .reg{ display:none !important; }
  body.hide-safe .marks .safe-area{ opacity:0 !important; }

  /* ===== PRINT: absolute anchoring, no extra whitespace ===== */
  @media print{
    @page{ size: 216mm 303mm; margin:0; }
    html,body{ width:216mm; height:303mm; margin:0; padding:0; }
    #menubar,#toolbar,#sidebar{ display:none!important; }
    #pages{ margin:0; position: static !important; }
    .sheet{ position: relative !important; left:0!important; top:0!important; width:216mm!important; height:303mm!important; margin:0!important; box-shadow:none!important; border:none!important; page-break-after: always; page-break-inside: avoid; overflow:hidden; }
    .sheet:last-child{ page-break-after:auto; }
    .trim{ left:3mm!important; top:3mm!important; width:210mm!important; height:297mm!important; }
    :root{ --m-top: 12mm; --m-bot: 12mm; --m-in: 12mm; --m-out: 12mm; }
    body.pdf-mirror .sheet.even{ --m-in: 20mm; --m-out: 14mm; }
    *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  }
</style>
</head>
<body class="theme-normal">

  <!-- ===== Menubar ===== -->
  <nav id="menubar" class="menubar">
    <div class="menu" data-menu="file">
      <button>Plik</button>
      <div class="dropdown">
        <div class="item" id="mNew">üÜï Nowy <span class="k">Ctrl+N</span></div>
        <div class="item" id="mOpen">üìÇ Otw√≥rz‚Ä¶ <span class="k">Ctrl+O</span></div>
        <input id="openInput" type="file" accept=".webdoc,application/json" style="display:none" />
        <div class="item" id="mSave">üíæ Zapisz (.webdoc) <span class="k">Ctrl+S</span></div>
        <div class="sep"></div>
        <div class="item" id="mExit">Zamknij</div>
      </div>
    </div>

    <div class="menu" data-menu="edit">
      <button>Edycja</button>
      <div class="dropdown">
        <div class="item">(Wkr√≥tce) Tryb edycji blok√≥w</div>
        <div class="item">(Wkr√≥tce) Cofnij / Pon√≥w</div>
      </div>
    </div>

    <div class="menu" data-menu="opts">
      <button>Opcje</button>
      <div class="dropdown">
        <div class="item"><label><input type="checkbox" id="chkGuides" checked /> Linie pomocnicze</label></div>
        <div class="item"><label><input type="checkbox" id="chkCrops" checked /> Znaczniki ciƒôcia</label></div>
        <div class="item"><label><input type="checkbox" id="chkColor" checked /> Pasy kolor√≥w</label></div>
        <div class="item"><label><input type="checkbox" id="chkReg" checked /> Krzy≈ºe pasowania</label></div>
        <div class="item"><label><input type="checkbox" id="chkSafe" /> Safe area</label></div>
        <div class="item"><label><input type="checkbox" id="chkShop" /> Tryb drukarni (siatka)</label></div>
        <div class="sep"></div>
        <div class="item">Motyw: 
          <select id="themeSel" class="field right">
            <option value="normal">Normal</option>
            <option value="medium">Medium (szary)</option>
            <option value="dark">Dark</option>
          </select>
        </div>
        <div class="item"><label><input type="checkbox" id="chkMirror" /> Lustrzany grzbiet (PDF)</label></div>
        <div class="item">Preset paska: 
          <select id="selColorPreset" class="field right">
            <option value="std">Standard</option>
            <option value="ugra">Ugra/Fogra 21</option>
          </select>
        </div>
      </div>
    </div>

    <div class="menu" data-menu="exp">
      <button>Eksport</button>
      <div class="dropdown">
        <div class="item" id="mPdfBleed">üìÑ PDF ‚Äî ze spadami</div>
        <div class="item" id="mPdfA4">üìÑ PDF ‚Äî A4 (bez spad√≥w)</div>
      </div>
    </div>

    <div class="spacer"></div>
    <div class="stat">WebDoc v0.1.0</div>
  </nav>

  <!-- ===== Pager (compact) ===== -->
  <div id="toolbar" class="toolbar">
    <button class="btn btn-icon" id="firstBtn" title="Pierwsza">‚ü™</button>
    <button class="btn btn-icon" id="prevBtn" title="Poprzednia">‚Äπ</button>
    <span class="stat">Strona <span id="cur">1</span>/<span id="tot">32</span></span>
    <input class="field" type="number" id="goto" min="1" max="32" value="1" />
    <button class="btn" id="goBtn">Id≈∫</button>
    <button class="btn btn-icon" id="nextBtn" title="Nastƒôpna">‚Ä∫</button>
    <button class="btn btn-icon" id="lastBtn" title="Ostatnia">‚ü´</button>
    <div class="spacer"></div>
  </div>

  <!-- Sidebar & Pages -->
  <aside id="sidebar"><div id="thumbs"></div></aside>
  <div id="pages"></div>

  <!-- Seed: WebDoc JSON (single-file, embeddable assets) -->
  <script id="webdoc" type="application/json">{
    "webdoc":"0.1.0",
    "meta":{"title":"FanZin RPG #0","pages":32},
    "assets":{
      "img/example.svg":"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='600' height='240'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%23e8f7fb'/><stop offset='1' stop-color='%23f5e8ff'/></linearGradient></defs><rect width='100%' height='100%' fill='url(%23g)'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Segoe UI, Arial' font-size='28' fill='%23555'>SVG w WebDoc</text></svg>"
    },
    "pages":[
      {"id":"p1","header":{"title":"ROZDZIA≈Å PIERWSZY ‚Äî TWORZENIE POSTACI"},
       "flow":[
         {"type":"cols","count":2,"blocks":[
           {"type":"para","text":"Gdy grasz fabularnie, wcielasz siƒô w innƒÖ osobƒô ‚Äî postaƒá, kt√≥rƒÖ sam tworzysz. GURPS pozwala dok≈Çadnie zdecydowaƒá, jakim bohaterem chcesz zostaƒá. G√≥rnik asteroid? Czarodziej? Zawodowy podr√≥≈ºnik w czasie?"},
           {"type":"para","text":"MG (Mistrz Gry ‚Äî osoba prowadzƒÖca rozgrywkƒô, ang. GM) przydzieli ci pulƒô punkt√≥w postaci, za kt√≥re kupujesz swoje zdolno≈õci. Im wiƒôkszƒÖ chcesz mieƒá si≈Çƒô, tym wiƒôcej punkt√≥w to kosztuje. Mo≈ºesz te≈º nabywaƒá cechy spo≈Çeczne, takie jak majƒÖtek, oraz zalety."}
         ]},
         {"type":"spanner","blocks":[{"type":"h2","text":"PUNKTY POSTACI"}]},
         {"type":"cols","count":3,"blocks":[
           {"type":"para","text":"Punkty postaci to \"waluta\" tworzenia bohatera. Wszystko, co zwiƒôksza twoje mo≈ºliwo≈õci, kosztuje punkty; wszystko, co obni≈ºa twoje mo≈ºliwo≈õci, oddaje ci punkty."},
           {"type":"fig","height":"h40","caption":"Schemat: przep≈Çyw punkt√≥w postaci","src":"img/example.svg"}
         ]}
       ],
       "footer":{"left":"Rozdzia≈Ç 1 ‚Äî Tworzenie postaci"}
      }
    ]
  }</script>

<script>
(function(){
  'use strict';
  const VERSION = '0.1.0';

  // ---------- Menubar logic ----------
  const menubar = document.getElementById('menubar');
  menubar.addEventListener('click', (e)=>{
    const btn = e.target.closest('.menu > button');
    if(btn){ const host = btn.parentElement; document.querySelectorAll('.menu.open').forEach(m=> m!==host && m.classList.remove('open')); host.classList.toggle('open'); }
    const item = e.target.closest('.item'); if(item && !item.querySelector('label')){ document.querySelectorAll('.menu.open').forEach(m=> m.classList.remove('open')); }
  });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.menu.open').forEach(m=> m.classList.remove('open')); } });
  document.addEventListener('click', (e)=>{ if(!e.target.closest('.menubar')){ document.querySelectorAll('.menu.open').forEach(m=> m.classList.remove('open')); } }, true);

  // ---------- Theme ----------
  const themeSel = document.getElementById('themeSel');
  function applyTheme(){ const v = themeSel.value; document.body.classList.remove('theme-normal','theme-medium','theme-dark'); document.body.classList.add('theme-'+v); }
  themeSel.addEventListener('change', applyTheme); applyTheme();

  // ---------- Options toggles ----------
  const chkGuides = document.getElementById('chkGuides');
  const chkCrops = document.getElementById('chkCrops');
  const chkColor = document.getElementById('chkColor');
  const chkReg = document.getElementById('chkReg');
  const chkSafe = document.getElementById('chkSafe');
  const chkShop = document.getElementById('chkShop');
  const chkMirror = document.getElementById('chkMirror');
  function applyToggles(){
    document.body.classList.toggle('hide-guides', !chkGuides.checked);
    document.body.classList.toggle('hide-crops', !chkCrops.checked);
    document.body.classList.toggle('hide-colorbar', !chkColor.checked);
    document.body.classList.toggle('hide-reg', !chkReg.checked);
    document.body.classList.toggle('hide-safe', !chkSafe.checked);
    document.body.classList.toggle('printshop', chkShop.checked);
    document.body.classList.toggle('pdf-mirror', chkMirror.checked);
  }
  [chkGuides,chkCrops,chkColor,chkReg,chkSafe,chkShop,chkMirror].forEach(el=> el.addEventListener('change', applyToggles));
  applyToggles();

  // ---------- Export buttons ----------
  const mPdfBleed = document.getElementById('mPdfBleed');
  const mPdfA4 = document.getElementById('mPdfA4');

  function injectPrintStyle(css){ let t=document.getElementById('print-style'); if(t) t.remove(); t=document.createElement('style'); t.id='print-style'; t.appendChild(document.createTextNode(css)); document.head.appendChild(t); }
  function prePrint(){ applyToggles(); window.scrollTo({top:0,behavior:'auto'}); }
  function postPrint(){ const t=document.getElementById('print-style'); if(t) t.remove(); buildThumbnails(); }
  window.addEventListener('afterprint', postPrint);

  mPdfBleed.addEventListener('click', ()=>{ prePrint(); injectPrintStyle('@page{size:216mm 303mm;margin:0} html,body{width:216mm;height:303mm;margin:0;padding:0} #pages{margin:0;position:static!important} .sheet{left:0;top:0;width:216mm!important;height:303mm!important;margin:0!important;position:relative!important} .trim{left:3mm!important;top:3mm!important;width:210mm!important;height:297mm!important} :root{--m-top:12mm;--m-bot:12mm;--m-in:12mm;--m-out:12mm}'); setTimeout(()=>window.print(), 100); });
  mPdfA4.addEventListener('click', ()=>{ prePrint(); injectPrintStyle('@page{size:210mm 297mm;margin:0} html,body{width:210mm;height:297mm;margin:0;padding:0} #pages{margin:0;position:static!important} .sheet{left:0;top:0;width:210mm!important;height:297mm!important;margin:0!important;position:relative!important} .trim{left:0!important;top:0!important;width:210mm!important;height:297mm!important} :root{--m-top:12mm;--m-bot:12mm;--m-in:12mm;--m-out:12mm} .crop,.marks{display:none!important}'); setTimeout(()=>window.print(), 100); });

  // ---------- Pager ----------
  const pagesEl = document.getElementById('pages');
  const thumbsEl = document.getElementById('thumbs');
  const curEl = document.getElementById('cur'); const totEl = document.getElementById('tot'); const gotoEl = document.getElementById('goto');
  const prevBtn = document.getElementById('prevBtn'); const nextBtn = document.getElementById('nextBtn'); const firstBtn = document.getElementById('firstBtn'); const lastBtn = document.getElementById('lastBtn'); const goBtn = document.getElementById('goBtn');
  let TOTAL = 32; let cur=0;

  function setActiveThumb(){ document.querySelectorAll('.thumb.active').forEach(e=> e.classList.remove('active')); const t=thumbsEl.querySelector('.thumb[data-index="'+cur+'"]'); if(t) t.classList.add('active'); }
  function snapTo(idx){ cur=Math.max(0,Math.min(TOTAL-1,idx)); pages[cur].scrollIntoView({behavior:'smooth',block:'start'}); curEl.textContent=String(cur+1); gotoEl.value=String(cur+1); prevBtn.disabled=(cur===0); firstBtn.disabled=(cur===0); nextBtn.disabled=(cur===TOTAL-1); lastBtn.disabled=(cur===TOTAL-1); setActiveThumb(); }
  prevBtn.addEventListener('click',()=>snapTo(cur-1)); nextBtn.addEventListener('click',()=>snapTo(cur+1)); firstBtn.addEventListener('click',()=>snapTo(0)); lastBtn.addEventListener('click',()=>snapTo(TOTAL-1));
  goBtn.addEventListener('click',()=>{ const v=parseInt(gotoEl.value,10)||1; snapTo(v-1); });
  gotoEl.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ const v=parseInt(gotoEl.value,10)||1; snapTo(v-1); }});
  window.addEventListener('keydown', (e)=>{ if(e.target===gotoEl) return; if(e.key==='ArrowRight'||e.key==='PageDown') snapTo(cur+1); if(e.key==='ArrowLeft'||e.key==='PageUp') snapTo(cur-1); if(e.key==='Home') snapTo(0); if(e.key==='End') snapTo(TOTAL-1); });

  // ---------- Renderer: WebDoc -> DOM ----------
  function makeTrim(sheet){ const t=document.createElement('div'); t.className='trim'; for(const c of ['tl','tr','bl','br']){ const m=document.createElement('div'); m.className='crop '+c; t.appendChild(m);} sheet.appendChild(t); return t; }
  function addMarks(sheet, idx){ const m=document.createElement('div'); m.className='marks'; const cb=document.createElement('div'); cb.className='colorbar'; m.appendChild(cb); const info=document.createElement('div'); info.className='info'; info.textContent='WebDoc v'+VERSION+' ‚Äî strona '+(idx+1)+'/'+TOTAL; m.appendChild(info); ['tl','tr','bl','br'].forEach(pos=>{ const r=document.createElement('div'); r.className='reg '+pos; m.appendChild(r); }); const safe=document.createElement('div'); safe.className='safe-area'; m.appendChild(safe); const slur=document.createElement('div'); slur.className='slur'; m.appendChild(slur); sheet.appendChild(m); }
  function applyColorPreset(){ const preset=document.getElementById('selColorPreset').value; const bars=document.querySelectorAll('.marks .colorbar'); bars.forEach(bar=>{ bar.innerHTML=''; let patches=[]; if(preset==='ugra'){ patches=['c','m','y','k']; for(let i=0;i<=20;i++){ const val=Math.round((i/20)*90); patches.push('g'+(val||'90')); } } else { patches=['c','m','y','k','r','g','b','w','g10','g20','g30','g40','g50','g60','g70','g80','g90']; } patches.forEach(p=>{ const d=document.createElement('div'); d.className='patch '+p; bar.appendChild(d); }); }); }
  document.getElementById('selColorPreset').addEventListener('change', applyColorPreset);

  function el(tag, cls, html){ const x=document.createElement(tag); if(cls) x.className=cls; if(html!=null) x.innerHTML=html; return x; }
  function pageSkeleton(p, idx){ const sheet=el('section','sheet '+(idx%2?'even':'odd')); const trim=makeTrim(sheet); const content=el('div','content'); trim.appendChild(content); addMarks(sheet, idx);
    if(p.header){ const head=el('header','head'); head.innerHTML = (p.header.kicker? '<div class="kicker">'+p.header.kicker+'</div>':'' ) + '<h1 class="title">'+(p.header.title||'')+'</h1>'; content.appendChild(head); }
    return {sheet, content}; }

  function mkPara(t){ return el('p',null, escapeHtml(t)); }
  function mkH2(t){ return el('h2','', escapeHtml(t)); }
  function mkFig(obj){ const f=el('figure', obj.span==='all'?'span-all':''); if(obj.src){ const im=new Image(); im.src = assets[obj.src]||obj.src; im.style.width='100%'; im.style.display='block'; f.appendChild(im); } else { const ph=el('div','ph '+(obj.height||'h40')); f.appendChild(ph); } if(obj.caption){ const cap=el('figcaption',null,escapeHtml(obj.caption)); f.appendChild(cap); } return f; }

  function blockToNode(b){
    if(b.type==='para') return mkPara(b.text||'');
    if(b.type==='h2') { const h=mkH2(b.text||''); h.classList.add('span-all'); return h; }
    if(b.type==='fig') return mkFig(b);
    // fallback lorem
    return mkPara(loremPara());
  }

  function flowToNodes(flow){
    const nodes=[];
    for(const seg of flow){
      if(seg.type==='cols'){
        const d=el('div','cols cols-'+(seg.count||1)+' split');
        for(const b of (seg.blocks||[])) d.appendChild(blockToNode(b));
        nodes.push(d);
      } else if(seg.type==='spanner'){
        const d=el('div','cols cols-1 split');
        for(const b of (seg.blocks||[])){ const n=blockToNode(b); n.classList && n.classList.add('span-all'); d.appendChild(n); }
        nodes.push(d);
      } else if(seg.type==='rule'){
        nodes.push(el('hr','rule'));
      }
    }
    return nodes;
  }

  function renderFromDoc(doc){
    pagesEl.innerHTML=''; thumbsEl.innerHTML='';
    TOTAL = Math.max(1, +((doc.meta&&doc.meta.pages)||32));
    const docPages = doc.pages && doc.pages.length ? doc.pages : [];
    for(let i=0;i<TOTAL;i++){
      const p = docPages[i] || { id:'p'+(i+1), header:{ title: 'Artyku≈Ç ‚Äî Strona '+(i+1) }, flow:[ {type:'cols', count: (i%3)+1, blocks:[ {type:'para'} , {type:'para'}, {type:'fig', height:'h40'} ] } ], footer:{ left:'FanZin ‚Äî Demo' } };
      const {sheet, content} = pageSkeleton(p, i);
      const nodes = flowToNodes(p.flow||[]); nodes.forEach(n=> content.appendChild(n));
      const foot=el('footer','foot'); foot.innerHTML='<span>'+(p.footer&&p.footer.left? escapeHtml(p.footer.left):'')+'</span><span>Strona '+(i+1)+' / '+TOTAL+' ‚Äî WebDoc '+VERSION+'</span>';
      content.appendChild(foot);
      pagesEl.appendChild(sheet);
    }
    pages = Array.from(document.querySelectorAll('.sheet'));
    buildThumbnails();
    cur=0; curEl.textContent='1'; totEl.textContent=String(TOTAL); gotoEl.max=String(TOTAL); snapTo(0); applyColorPreset();
  }

  // ---------- Thumbnails ----------
  let pages = [];
  function buildThumbnails(){ thumbsEl.innerHTML=''; if(!pages.length) return; const r=pages[0].getBoundingClientRect(); const baseW=r.width||pages[0].offsetWidth||1000; const baseH=r.height||pages[0].offsetHeight||1400; pages.forEach((p,idx)=>{ const wrap=el('div','thumb'); wrap.dataset.index=String(idx); const mini=el('div','mini-wrap'); const clone=p.cloneNode(true); clone.style.pointerEvents='none'; mini.appendChild(clone); wrap.appendChild(mini); const meta=el('div','mini-meta','Strona '+(idx+1)); wrap.appendChild(meta); wrap.addEventListener('click',()=>snapTo(idx)); thumbsEl.appendChild(wrap); const availW=mini.clientWidth; let scale=availW/baseW; if(!isFinite(scale)||scale<=0){ scale=0.2; } clone.style.transformOrigin='top left'; clone.style.transform='scale('+scale.toFixed(4)+')'; mini.style.height=(baseH*scale)+'px'; }); setActiveThumb(); }
  window.addEventListener('resize', buildThumbnails);

  // ---------- Lorem helpers ----------
  function loremSentence(){ const bits=['Lorem ipsum','dolor sit amet','nerdowski ton','mechanika','wielokolumnowy layout','mikrotypografia','≈õwiatotw√≥rstwo','bestiariusz','jednostrza≈Ç','test umiejƒôtno≈õci','MG u≈õmiecha siƒô','ko≈õci na stole','klarowny interfejs']; const len=6+Math.floor(Math.random()*8); let out=[]; for(let i=0;i<len;i++) out.push(bits[Math.floor(Math.random()*bits.length)]); let s=out.join(' ')+'.'; return s.charAt(0).toUpperCase()+s.slice(1); }
  function loremPara(){ const n=3+Math.floor(Math.random()*5); let p=[]; for(let i=0;i<n;i++) p.push(loremSentence()); return p.join(' '); }
  function escapeHtml(s){ return String(s).replace(/[&<>]/g, ch=> ({'&':'&amp;','<':'&lt;','>':'&gt;'}[ch])); }

  // ---------- WebDoc I/O (single file) ----------
  let currentDoc = null; let assets = {};
  function seedDoc(){ try{ const raw=document.getElementById('webdoc').textContent; const j=JSON.parse(raw); return j; }catch(e){ return { webdoc:VERSION, meta:{title:'Nowy dokument', pages:32}, assets:{}, pages:[] }; } }
  function normalizeDoc(doc){ if(!doc.webdoc) doc.webdoc = VERSION; if(!doc.meta) doc.meta = {title:'Bez tytu≈Çu', pages:32}; if(!doc.assets) doc.assets={}; if(!Array.isArray(doc.pages)) doc.pages=[]; assets = doc.assets; return doc; }

  function saveDocFile(){ const blob = new Blob([JSON.stringify(currentDoc, null, 2)], {type:'application/json'}); const a=document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = (currentDoc.meta.title||'document') + '.webdoc'; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0); }
  function openDocFile(file){ const fr = new FileReader(); fr.onload = ()=>{ try{ const j = JSON.parse(fr.result); currentDoc = normalizeDoc(j); renderFromDoc(currentDoc); }catch(err){ alert('Nieprawid≈Çowy plik .webdoc'); } }; fr.readAsText(file, 'utf-8'); }

  // Menubar actions
  const mNew = document.getElementById('mNew'); const mOpen = document.getElementById('mOpen'); const mSave = document.getElementById('mSave'); const mExit = document.getElementById('mExit');
  const openInput = document.getElementById('openInput');
  mNew.addEventListener('click', ()=>{ currentDoc = normalizeDoc({ webdoc:VERSION, meta:{title:'Nowy WebDoc', pages:32}, assets:{}, pages:[] }); renderFromDoc(currentDoc); });
  mOpen.addEventListener('click', ()=> openInput.click());
  openInput.addEventListener('change', (e)=>{ const f=e.target.files&&e.target.files[0]; if(f) openDocFile(f); e.target.value=''; });
  mSave.addEventListener('click', saveDocFile);
  mExit.addEventListener('click', ()=>{ window.close && window.close(); });

  // ---------- Boot ----------
  currentDoc = normalizeDoc(seedDoc());
  renderFromDoc(currentDoc);
})();
</script>
</body>
</html>
