<!--
 FanZin A4 — HTML Paged v0.6.1 (LTS) — rollback to stable 0.6.0 + fixes
 @version 0.6.2
 @codename "Nawigator LTS"
 @changelog
  - Rolled back to stable 0.6.0 code path (UI + thumbnails + 32 pages)
  - Fixed: mirrored inner/outer margins (odd/even) and tighter side paddings
  - Fixed: spanners in multicol (no overlay) via break-before/after: column
  - Fixed: print is exactly 32 pages; overflow hidden; page-break-inside: avoid
  - Thumbnails: robust dynamic scaling; rebuild on load/resize/afterprint
-->
<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta http-equiv="Content-Language" content="pl" />
<title>FanZin RPG — A4 (HTML Paged v0.6.2 LTS)</title>
<style>
  /* ====== Page Setup (manual pagination) ====== */
  :root{
    --bleed: 3mm;              /* spady */
    --page-w: 210mm;           /* trim width */
    --page-h: 297mm;           /* trim height */
    --sheet-w: calc(var(--page-w) + 2*var(--bleed));
    --sheet-h: calc(var(--page-h) + 2*var(--bleed));
    --m-top: 15mm; --m-out: 17mm; --m-bot: 20mm; --m-in: 17mm; /* trim margins */
    --col-gap: 6mm;
    --accent: #06b6d4; /* cyjan */
    --ink: #111; --ink-soft:#444; --rule:#ddd; --paper:#fff; --thumb-bg:#f8f8f8;
    --font-body: "Literata", "Source Serif 4", "Noto Serif", "PT Serif", ui-serif, Georgia, serif;
    --font-ui: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "DejaVu Sans", sans-serif;
    --ui-h: 56px; --sidebar-w: 210px;
    --crop-l: 7mm; --crop-w: 0.25mm; /* crop marks length & width */
  }

  @media screen{ html,body{ background:#ffffff; margin:0; padding:0; } }
  @media print{
    @page { size: var(--sheet-w) var(--sheet-h); margin: 0; }
    #ui, #sidebar { display:none !important; }
    #pages{ margin:0; }
    .sheet{ height: var(--sheet-h) !important; width: var(--sheet-w) !important; page-break-after: always; page-break-inside: avoid; box-shadow:none; border:none; overflow: hidden; }
    .sheet:last-child{ page-break-after: auto; }
    .trim{ height: var(--page-h) !important; width: var(--page-w) !important; }
    /* Druk: domyślnie ukryj linie pomocnicze */
    .trim::before{ display:none; }
    /* Opcja: bez znaczników cięcia */
    body.no-crop .crop{ display:none !important; }
  }

  /* ====== Typography ====== */
  body{ font-family: var(--font-body); font-size: 10.5pt; line-height: 1.42; font-kerning: normal; }
  *{ -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; }
  h1,h2,h3{ font-family: var(--font-ui); margin: 0 0 3mm 0; line-height: 1.2; }
  h1.title{ font-size: 22pt; }
  h2{ font-size: 13pt; }
  h3{ font-size: 11pt; }
  p{ margin: 0 0 3.2mm 0; hyphens: auto; orphans:3; widows:3; }
  .kicker{ text-transform: uppercase; letter-spacing: .08em; color:#666; font-size:9pt; }
  .muted{ color: var(--ink-soft); }
  .rule{ border-top: .3pt solid var(--rule); }
  .accent{ color: var(--accent); }

  /* ====== UI Toolbar ====== */
  #ui{ position: sticky; top: 0; z-index: 1000; background:#fff; border-bottom:1px solid #e6e6e6;
       font-family: var(--font-ui); height: var(--ui-h); display:flex; align-items:center; gap:8px; padding: 8px 12px; }
  #ui .btn{ border:1px solid #ddd; background:#fafafa; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:14px; }
  #ui .btn:disabled{ opacity:.5; cursor:not-allowed; }
  #ui .stat{ font-size:14px; color:#333; }
  #ui input[type="number"]{ width:64px; padding:6px 8px; border:1px solid #ddd; border-radius:6px; }
  #ui .spacer{ flex:1 1 auto; }
  #ui label{ display:inline-flex; align-items:center; gap:6px; font-size:13px; padding:0 6px; }

  /* ====== Sidebar Thumbnails ====== */
  #sidebar{ position: fixed; top: var(--ui-h); left: 0; bottom: 0; width: var(--sidebar-w); background: var(--thumb-bg);
            border-right:1px solid #e6e6e6; overflow: auto; padding: 10px; }
  #thumbs .thumb{ padding:8px; margin-bottom:10px; background:#fff; border:1px solid #e6e6e6; border-radius:8px; cursor:pointer; }
  #thumbs .thumb.active{ outline:2px solid var(--accent); }
  .mini-wrap{ width: 150px; height: 215px; overflow: hidden; position: relative; margin: 0 auto 6px; }
  .mini-wrap .sheet{ box-shadow: none; border:0.5pt solid #e6e6e6; }
  .mini-wrap .trim::before{ display:none; } /* bez guides w miniaturze */
  .mini-wrap .crop{ display:none; }
  .mini-meta{ text-align:center; font: 12px var(--font-ui); color:#333; }

  /* ====== Pages Container ====== */
  #pages{ margin-left: calc(var(--sidebar-w) + 12px); }

  /* ====== Sheet (bleed) + Trim + Guides + Crop marks ====== */
  .sheet{ position: relative; width: var(--sheet-w); height: var(--sheet-h); background: var(--paper); color: var(--ink);
          box-shadow: 0 6px 20px rgba(0,0,0,.12); margin: 16px auto; border: 0.5pt solid #e6e6e6; scroll-margin-top: calc(var(--ui-h) + 12px); overflow: hidden; }
  /* mirrored margin variables per page */
  .sheet{ --inPage: var(--m-in); --outPage: var(--m-out); }
  .sheet.even{ --inPage: var(--m-out); --outPage: var(--m-in); }

  /* crop marks (manual) */
  .crop{ position:absolute; width:0; height:0; }
  .crop::before, .crop::after{ content:""; position:absolute; background:#000; }
  .crop.tl{ left: var(--bleed); top: var(--bleed); }
  .crop.tr{ right: var(--bleed); top: var(--bleed); }
  .crop.bl{ left: var(--bleed); bottom: var(--bleed); }
  .crop.br{ right: var(--bleed); bottom: var(--bleed); }
  /* poziome */
  .crop.tl::after, .crop.tr::after, .crop.bl::after, .crop.br::after{ height: var(--crop-w); width: var(--crop-l); }
  .crop.tl::after{ left: 0; top: calc(var(--m-top) - var(--crop-w)); transform: translateX(calc(-1 * var(--crop-l))); }
  .crop.tr::after{ right: 0; top: calc(var(--m-top) - var(--crop-w)); }
  .crop.bl::after{ left: 0; bottom: calc(var(--m-bot) - var(--crop-w)); transform: translateX(calc(-1 * var(--crop-l))); }
  .crop.br::after{ right: 0; bottom: calc(var(--m-bot) - var(--crop-w)); }
  /* pionowe (mirrored inner/outer) */
  .crop.tl::before, .crop.tr::before, .crop.bl::before, .crop.br::before{ width: var(--crop-w); height: var(--crop-l); }
  .crop.tl::before{ top: 0; left: calc(var(--inPage) - var(--crop-w)); transform: translateY(calc(-1 * var(--crop-l))); }
  .crop.tr::before{ top: 0; right: calc(var(--outPage) - var(--crop-w)); transform: translateY(calc(-1 * var(--crop-l))); }
  .crop.bl::before{ bottom: 0; left: calc(var(--inPage) - var(--crop-w)); }
  .crop.br::before{ bottom: 0; right: calc(var(--outPage) - var(--crop-w)); }

  /* Trim box and margin guides */
  .trim{ position: absolute; left: var(--bleed); top: var(--bleed); width: var(--page-w); height: var(--page-h); background: transparent; }
  .trim::before{ content:""; position:absolute; left: var(--inPage); right: var(--outPage); top: var(--m-top); bottom: var(--m-bot);
                 border:0.4pt dashed #bdbdbd; pointer-events:none; }

  /* Content frame inside trim (no extra side paddings) */
  .content{ position:absolute; left: var(--inPage); right: var(--outPage); top: var(--m-top); bottom: var(--m-bot); }

  /* Professional print marks */
  .marks{ position:absolute; inset:0; pointer-events:none; }
  .marks .colorbar{ position:absolute; left: var(--bleed); right: var(--bleed); bottom: 0.8mm; height: 6mm; display:flex; gap:0.6mm; align-items:stretch; }
  .marks .patch{ flex:0 0 10mm; height:100%; border:0.2pt solid #ccc; }
  .patch.c{ background:#00B5E2; } .patch.m{ background:#D5006D; } .patch.y{ background:#FFD400; } .patch.k{ background:#000; }
  .patch.r{ background:#FF3B30; } .patch.g{ background:#34C759; } .patch.b{ background:#007AFF; }
  .patch.w{ background:#fff; }
  .patch.g10{ background:#1a1a1a; } .patch.g20{ background:#333; } .patch.g30{ background:#4d4d4d; }
  .patch.g40{ background:#666; } .patch.g50{ background:#808080; } .patch.g60{ background:#999; }
  .patch.g70{ background:#b3b3b3; } .patch.g80{ background:#ccc; } .patch.g90{ background:#e6e6e6; }
  .marks .info{ position:absolute; right: var(--bleed); top: 0.8mm; font: 9px var(--font-ui); color:#000; background:#fff; padding:2px 4px; border:0.2pt solid #ccc; }
  .marks .reg{ position:absolute; width:7mm; height:7mm; border-radius:50%; border:0.3pt solid #000; }
  .marks .reg::before, .marks .reg::after{ content:""; position:absolute; left:50%; top:50%; background:#000; transform:translate(-50%,-50%); }
  .marks .reg::before{ width:6mm; height:0.25mm; }
  .marks .reg::after{ width:0.25mm; height:6mm; }
  .marks .reg.tl{ left: 1mm; top: 1mm; } .marks .reg.tr{ right: 1mm; top: 1mm; }
  .marks .reg.bl{ left: 1mm; bottom: 1mm; } .marks .reg.br{ right: 1mm; bottom: 1mm; }
  .marks .safe-area{ position:absolute; left: var(--bleed); right: var(--bleed); top: var(--bleed); bottom: var(--bleed); border:0.2pt dotted #bbb; }

  /* ====== Content Blocks */ (inside .trim) ====== */
  .head{ padding: 8mm 0 4mm 0; border-bottom: .3pt solid var(--rule); }
  .cols{ padding: 4mm 0 0 0; hyphens: auto; column-fill: auto; }
  .cols-1{ column-count: 1; }
  .cols-2{ column-count: 2; column-gap: var(--col-gap); }
  .cols-3{ column-count: 3; column-gap: var(--col-gap); }
  .cols p, .cols li, .cols figure, .cols h2, .cols h3{ break-inside: avoid-column; }
  .span-all{ column-span: all; break-before: column; break-after: column; }
  .split{ padding-bottom: 6mm; }
  .foot{ padding: 4mm 0 6mm 0; border-top: .3pt solid var(--rule); font-size: 9pt; color:#666; display:flex; justify-content:space-between; }

  /* Figures */
  figure{ margin: 0 0 4mm 0; }
  .ph{ width: 100%; background: linear-gradient(135deg,#e8f7fb,#f5e8ff); border:0.3pt solid #dcdcdc; }
  .ph.h30{ height: 30mm; } .ph.h40{ height: 40mm; } .ph.h50{ height: 50mm; } .ph.h60{ height: 60mm; }
  figure figcaption{ font-size: 9pt; color:#666; margin-top: 1.6mm; }

  /* Utilities */
  .mb2{ margin-bottom: 2mm; } .mb4{ margin-bottom: 4mm; } .mb6{ margin-bottom: 6mm; }

  /* Toggles */
  body.hide-guides .trim::before{ display:none !important; }
  body.hide-guides .marks .safe-area{ opacity:0; }
  body.no-crop .crop{ display:none !important; }
</style>
</head>
<body>

  <!-- ======= UI Toolbar ======= -->
  <div id="ui">
    <button class="btn" id="firstBtn">⏮︎ Pierwsza</button>
    <button class="btn" id="prevBtn">◀︎ Poprzednia</button>
    <div class="stat">Strona <span id="cur">1</span> / <span id="tot">32</span></div>
    <input type="number" id="goto" min="1" max="32" value="1" />
    <button class="btn" id="goBtn">Idź</button>
    <button class="btn" id="nextBtn">Następna ▶︎</button>
    <button class="btn" id="lastBtn">Ostatnia ⏭︎</button>
    <div class="spacer"></div>
    <label><input type="checkbox" id="chkBleed" checked /> Spady + znaczniki</label>
    <label><input type="checkbox" id="chkGuides" /> Pokaż linie pomocnicze</label>
    <div class="stat muted" id="ver">FanZin A4 — v0.6.2 LTS</div>
    <button class="btn" id="pdfBtn">📄 Eksportuj PDF</button>
  </div>

  <!-- ======= Sidebar Thumbnails ======= -->
  <aside id="sidebar"><div id="thumbs"></div></aside>

  <!-- ======= Pages Container ======= -->
  <div id="pages"></div>

<script>
(function(){
  const TOTAL = 32;
  const VERSION = '0.6.1';
  const pagesEl = document.getElementById('pages');
  const curEl = document.getElementById('cur');
  const totEl = document.getElementById('tot');
  const gotoEl = document.getElementById('goto');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const firstBtn = document.getElementById('firstBtn');
  const lastBtn = document.getElementById('lastBtn');
  const goBtn = document.getElementById('goBtn');
  const thumbsEl = document.getElementById('thumbs');
  const pdfBtn = document.getElementById('pdfBtn');
  const chkBleed = document.getElementById('chkBleed');
  const chkGuides = document.getElementById('chkGuides');

  totEl.textContent = String(TOTAL);
  document.title = 'FanZin RPG — A4 (HTML Paged v' + VERSION + ' LTS)';

  /* Patterns of column blocks per page (flexible mixes) */
  const patterns = [
    ['2'], ['3'], ['1'], ['2','3'], ['3','2'], ['1','2'], ['2','1','3'], ['3','1'], ['2','2','3'], ['3','3','1']
  ];

  function loremSentence(){
    const bits = [
      'Lorem ipsum', 'dolor sit amet', 'konsekwentny nerdowski ton', 'mechanika stołu', 'wielokolumnowy layout', 'mikrotypografia', 'polskie dzielenie wyrazów', 'światotwórstwo', 'bestiariusz', 'przygoda jednostrzałowa', 'test umiejętności', 'MG uśmiecha się złowieszczo', 'kości toczą się po stole', 'patch edycji', 'klarowny interfejs zasad'
    ];
    const len = 6 + Math.floor(Math.random()*8);
    let out = [];
    for(let i=0;i<len;i++) out.push(bits[Math.floor(Math.random()*bits.length)]);
    let s = out.join(' ') + '.';
    s = s.charAt(0).toUpperCase() + s.slice(1);
    return s;
  }
  function loremPara(){
    const n = 3 + Math.floor(Math.random()*5);
    let p = [];
    for(let i=0;i<n;i++) p.push(loremSentence());
    return p.join(' ');
  }
  function fig(height){
    const h = height || ['h30','h40','h50','h60'][Math.floor(Math.random()*4)];
    const spanAll = Math.random() < 0.35; // część pełnej szerokości
    const f = document.createElement('figure');
    if(spanAll) f.classList.add('span-all');
    const img = document.createElement('div'); img.className = 'ph ' + h;
    const cap = document.createElement('figcaption'); cap.textContent = spanAll ? 'Ilustracja: placeholder (pełna szerokość)' : 'Ilustracja: placeholder';
    f.appendChild(img); f.appendChild(cap); return f;
  }
  function para(text){ const p = document.createElement('p'); p.textContent = text || loremPara(); return p; }

  function makeColsBlock(colsClass){
    const b = document.createElement('div'); b.className = 'cols ' + ('cols-' + colsClass) + ' split';
    const parts = 3 + Math.floor(Math.random()*5);
    for(let i=0;i<parts;i++){
      if(i>0 && i%3===0){ b.appendChild(fig()); }
      b.appendChild(para());
    }
    if(Math.random()<0.25) b.appendChild(fig('h40'));
    return b;
  }

  function makeTrim(sheet){
    const t = document.createElement('div'); t.className = 'trim';
    for(const c of ['tl','tr','bl','br']){ const m = document.createElement('div'); m.className = 'crop '+c; t.appendChild(m); }
    sheet.appendChild(t);
    return t;
  }
  function addMarks(sheet, pageIndex){
    const m = document.createElement('div'); m.className = 'marks';
    const cb = document.createElement('div'); cb.className = 'colorbar';
    const patches = ['c','m','y','k','r','g','b','w','g10','g20','g30','g40','g50','g60','g70','g80','g90'];
    patches.forEach(p=>{ const d=document.createElement('div'); d.className='patch '+p; cb.appendChild(d); });
    const info = document.createElement('div'); info.className='info'; info.textContent = 'FanZin · v'+VERSION+' · strona '+(pageIndex+1)+'/'+TOTAL+' · '+new Date().toLocaleString('pl-PL');
    m.appendChild(cb); m.appendChild(info);
    ['tl','tr','bl','br'].forEach(pos=>{ const r=document.createElement('div'); r.className='reg '+pos; m.appendChild(r); });
    const safe = document.createElement('div'); safe.className='safe-area'; m.appendChild(safe);
    sheet.appendChild(m);
  }

  function pageSkeleton(titleText, pageIndex){
    const sheet = document.createElement('section'); sheet.className = 'sheet ' + (pageIndex%2 ? 'even' : 'odd');
    const trim = makeTrim(sheet);
    const content = document.createElement('div'); content.className = 'content'; trim.appendChild(content);
    addMarks(sheet, pageIndex);

    const head = document.createElement('header'); head.className = 'head';
    head.innerHTML = '<div class="kicker">FanZin RPG · Numer 0</div>'+
                     '<h1 class="title">'+(titleText||'Artykuł demonstracyjny')+'</h1>';
    content.appendChild(head);
    return {sheet, content};
  }

  function chapterOnePage(pageIndex){
    const {sheet, content} = pageSkeleton('ROZDZIAŁ PIERWSZY — TWORZENIE POSTACI', pageIndex);
    /* Two columns intro */
    const c2 = document.createElement('div'); c2.className = 'cols cols-2 split';
    c2.appendChild(para('Gdy grasz fabularnie, wcielasz się w inną osobę — postać, którą sam tworzysz. GURPS pozwala dokładnie zdecydować, jakim bohaterem chcesz zostać. Górnik asteroid? Czarodziej? Zawodowy podróżnik w czasie? Możesz wzorować się na fikcyjnym herosie lub heroinie, albo zbudować swoje nowe „ja” od podstaw. Kiedy już wiesz, jaką rolę chcesz odegrać, czas tchnąć życie w tę postać!'));
    c2.appendChild(para('MG (Mistrz Gry — osoba prowadząca rozgrywkę, ang. GM) przydzieli ci pulę punktów postaci, za które „kupujesz” swoje zdolności. Na przykład: im większą chcesz mieć siłę, tym więcej punktów to kosztuje. Możesz też nabywać korzystne cechy społeczne, takie jak majątek, oraz zalety — specjalne zdolności opisane w rozdziale 2.'));
    c2.appendChild(para('Jeśli chcesz mieć więcej zdolności niż pozwala twój budżet ustalony przez MG, możesz zdobyć dodatkowe punkty, akceptując cechy poniżej przeciętnej (np. siłę, wygląd, majątek, status) albo biorąc wady — konkretne ograniczenia, takie jak słaby wzrok czy lęk wysokości (zob. rozdział 3).'));
    c2.appendChild(para('Bardziej doświadczeni gracze mogą dostrajać te cechy za pomocą ulepszeń i ograniczeń; zob. s. 101–117. Takie modyfikatory podnoszą lub obniżają bazowy koszt punktowy zmodyfikowanej cechy.'));
    c2.appendChild(para('Zacznij od karty postaci (zob. s. 13) i wypełniaj ją w miarę postępów, pilnując wydawanych punktów. Na każdym etapie zamieściliśmy przykłady, które ilustrują proces.'));
    content.appendChild(c2);

    const cspan = document.createElement('div'); cspan.className = 'cols cols-2 split';
    const h2 = document.createElement('h2'); h2.className = 'span-all'; h2.textContent = 'PUNKTY POSTACI'; cspan.appendChild(h2);
    cspan.appendChild(para('Punkty postaci to „waluta” tworzenia bohatera. Wszystko, co zwiększa twoje możliwości, kosztuje punkty: musisz wydać liczbę punktów równą cenie danej zdolności, aby dodać ją do karty i używać w grze. Wszystko, co obniża twoje możliwości, ma koszt ujemny — czyli oddaje ci punkty.'));
    cspan.appendChild(para('Przykład: jeśli zaczynasz ze 125 punktami, kupisz 75 punktów zalet, a weźmiesz −15 punktów wad, zostanie ci 125 − 75 + 15 = 65 punktów.'));
    content.appendChild(cspan);

    const c3 = document.createElement('div'); c3.className = 'cols cols-3 split';
    c3.appendChild(para('Punkty początkowe'));
    c3.appendChild(para('To MG decyduje, z iloma punktami zaczną PG (PC) — bohaterowie graczy. Zależy to od tego, jak sprawne mają być postaci, i może się wahać od poniżej 25 punktów (małe dzieci) do 1000 punktów lub więcej (istoty na poziomie boskim), przy czym 100–200 punktów to wartość typowa dla zawodowych poszukiwaczy przygód.'));
    c3.appendChild(para('Ten poziom startowy bywa nazywany poziomem mocy kampanii (zob. Power Level, s. 487). To nie to samo co stawka kampanii! Bohaterowie, których zdolności pozwalają pokonać nawet najtwardszych przeciwników w optymistycznej fantasy, mogą mierzyć się ze śmiertelnym zagrożeniem w mrocznym scenariuszu grozy.'));
    c3.appendChild(para('W większości kampanii wszystkie PG zaczynają na tym samym poziomie mocy — to proste i sprawiedliwe. Jednak tak jak w prawdziwym życiu ludzie nie są równie utalentowani, tak i w fikcji często zdarza się postać wyraźnie przewyższająca innych. Jeśli wszyscy się zgadzają, część graczy może prowadzić „głównych protagonistów”…'));
    const figAll = document.createElement('figure'); figAll.className = 'span-all mb4';
    const img = document.createElement('div'); img.className = 'ph h40';
    const cap = document.createElement('figcaption'); cap.textContent = 'Schemat: przepływ punktów postaci';
    figAll.appendChild(img); figAll.appendChild(cap); c3.appendChild(figAll);
    content.appendChild(c3);

    const foot = document.createElement('footer'); foot.className = 'foot rule';
    foot.innerHTML = '<span>Rozdział 1 — Tworzenie postaci</span><span>Strona '+(pageIndex+1)+' / '+TOTAL+' — v'+VERSION+'</span>';
    content.appendChild(foot);
    return sheet;
  }

  function genericPage(i){
    const {sheet, content} = pageSkeleton('Artykuł demonstracyjny · Strona '+(i+1), i);
    const pat = patterns[i % patterns.length];
    for(const c of pat){ content.appendChild(makeColsBlock(c)); }
    const foot = document.createElement('footer'); foot.className = 'foot rule';
    foot.innerHTML = '<span>FanZin — Demo</span><span>Strona '+(i+1)+' / '+TOTAL+' — v'+VERSION+'</span>';
    content.appendChild(foot);
    return sheet;
  }

  // Generate pages
  for(let i=0;i<TOTAL;i++){
    const page = (i===0) ? chapterOnePage(i) : genericPage(i);
    page.dataset.index = String(i);
    pagesEl.appendChild(page);
  }

  const pages = Array.from(document.querySelectorAll('.sheet'));
  // current page index must be ready before any call
  let cur = 0;

  // Build thumbnails (clone & scale to fit)
  function buildThumbnails(){
    thumbsEl.innerHTML = '';
    // measure real page size once
    const r = pages[0].getBoundingClientRect();
    const baseW = r.width || pages[0].offsetWidth || 1000;
    const baseH = r.height || pages[0].offsetHeight || 1400;
    pages.forEach((p, idx)=>{
      const wrap = document.createElement('div'); wrap.className = 'thumb'; wrap.dataset.index = String(idx);
      const mini = document.createElement('div'); mini.className = 'mini-wrap';
      const clone = p.cloneNode(true);
      // prevent mini from catching events
      clone.style.pointerEvents = 'none';
      mini.appendChild(clone);
      wrap.appendChild(mini);
      const meta = document.createElement('div'); meta.className = 'mini-meta'; meta.textContent = 'Strona ' + (idx+1);
      wrap.appendChild(meta);
      wrap.addEventListener('click', ()=> snapTo(idx));
      thumbsEl.appendChild(wrap);
      // scale clone to fit width
      const availW = mini.clientWidth; let scale = availW / baseW; if(!isFinite(scale) || scale<=0){ scale = 0.2; }
      clone.style.transformOrigin = 'top left';
      clone.style.transform = 'scale(' + scale.toFixed(4) + ')';
      mini.style.height = (baseH * scale) + 'px';
    });
    setActiveThumb();
  }

  function setActiveThumb(){
    document.querySelectorAll('.thumb.active').forEach(e=> e.classList.remove('active'));
    const t = thumbsEl.querySelector('.thumb[data-index="'+cur+'"]'); if(t) t.classList.add('active');
  }

  function snapTo(idx){
    cur = Math.max(0, Math.min(TOTAL-1, idx));
    pages[cur].scrollIntoView({behavior:'smooth', block:'start'});
    curEl.textContent = String(cur+1);
    gotoEl.value = String(cur+1);
    prevBtn.disabled = (cur===0); firstBtn.disabled = (cur===0);
    nextBtn.disabled = (cur===TOTAL-1); lastBtn.disabled = (cur===TOTAL-1);
    setActiveThumb();
  }

  // UI events
  prevBtn.addEventListener('click', ()=> snapTo(cur-1));
  nextBtn.addEventListener('click', ()=> snapTo(cur+1));
  firstBtn.addEventListener('click', ()=> snapTo(0));
  lastBtn.addEventListener('click', ()=> snapTo(TOTAL-1));
  goBtn.addEventListener('click', ()=> { const v = parseInt(gotoEl.value,10)||1; snapTo(v-1); });
  gotoEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ const v=parseInt(gotoEl.value,10)||1; snapTo(v-1);} });

  // Keyboard shortcuts
  window.addEventListener('keydown', (e)=>{
    if(e.target===gotoEl) return;
    if(e.key==='ArrowRight' || e.key==='PageDown') snapTo(cur+1);
    if(e.key==='ArrowLeft'  || e.key==='PageUp')   snapTo(cur-1);
    if(e.key==='Home') snapTo(0);
    if(e.key==='End')  snapTo(TOTAL-1);
  });

  // Track scroll position to update page number and active thumb
  const obs = new IntersectionObserver((entries)=>{
    let topMost = null; let topY = Infinity;
    for(const e of entries){ if(e.isIntersecting){ const rr = e.target.getBoundingClientRect(); if(rr.top >= 0 && rr.top < topY){ topY = rr.top; topMost = e.target; } } }
    if(topMost){
      const idx = pages.indexOf(topMost);
      if(idx>=0){ cur = idx; curEl.textContent = String(cur+1); gotoEl.value = String(cur+1); setActiveThumb();
        prevBtn.disabled = (cur===0); firstBtn.disabled = (cur===0);
        nextBtn.disabled = (cur===TOTAL-1); lastBtn.disabled = (cur===TOTAL-1);
      }
    }
  }, { root: null, rootMargin: '0px', threshold: [0.6] });
  pages.forEach(p=> obs.observe(p));

  // PDF Export
  // Apply initial toggles
  document.body.classList.toggle('no-crop', !chkBleed.checked);
  document.body.classList.toggle('hide-guides', !chkGuides.checked);
  chkGuides.addEventListener('change', ()=> document.body.classList.toggle('hide-guides', !chkGuides.checked));
  chkBleed.addEventListener('change', ()=> document.body.classList.toggle('no-crop', !chkBleed.checked));

  pdfBtn.addEventListener('click', ()=>{
    document.body.classList.add('print-export');
    thumbsEl.innerHTML = '';
    window.scrollTo({ top: 0, behavior: 'auto' });
    setTimeout(()=> window.print(), 100);
  });
  window.addEventListener('afterprint', ()=>{ buildThumbnails(); document.body.classList.remove('print-export'); });

  // Build thumbs after layout
  window.addEventListener('load', buildThumbnails);
  window.addEventListener('resize', buildThumbnails);

  // Start at page 1
  snapTo(0);
})();
</script>
</body>
</html>
